<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‚ö° ‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°‡πÑ‡∏ü‡∏ü‡πâ‡∏≤ - Desktop Dashboard</title>
    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#fbbf24">
    <!-- Removed PWA-specific meta tags for iOS/Windows -->
    
    <!-- PWA Manifest -->
    <!-- PWA removed -->
    <!-- <link rel="manifest" href="/manifest.json"> -->
    
    <!-- Apple Touch Icons -->
    <!-- Removed apple-touch-icon -->
    
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzIiIGhlaWdodD0iMzIiIHZpZXdCb3g9IjAgMCAzMiAzMiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjMyIiBoZWlnaHQ9IjMyIiByeD0iNCIgZmlsbD0iI2ZiYmYyNCIvPgo8dGV4dCB4PSIxNiIgeT0iMTkiIGZvbnQtZmFtaWx5PSJBcmlhbCwgc2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgZmlsbD0iIzBmMTcyYSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZG9taW5hbnQtYmFzZWxpbmU9ImNlbnRyYWwiPuKaoTwvdGV4dD4KPC9zdmc+Cg==">
    
    <!-- SweetAlert2 CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/limonte-sweetalert2/11.10.1/sweetalert2.min.css">
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    
    <!-- DataTables CSS & JS -->
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #334155 100%);
            color: #f8fafc;
            min-height: 100vh;
        }

        /* Sidebar */
        .sidebar {
            position: fixed;
            top: 0;
            left: 0;
            width: 280px;
            height: 100vh;
            background: linear-gradient(180deg, rgba(30, 41, 59, 0.95) 0%, rgba(51, 65, 85, 0.95) 100%);
            backdrop-filter: blur(20px);
            border-right: 1px solid rgba(251, 191, 36, 0.3);
            z-index: 1000;
            transition: all 0.3s ease;
            overflow-y: auto;
        }

        .sidebar-header {
            padding: 2rem 1.5rem;
            border-bottom: 1px solid rgba(251, 191, 36, 0.2);
            text-align: center;
        }

        .sidebar-brand {
            display: flex;
            align-items: center;
            gap: 1rem;
            justify-content: center;
            margin-bottom: 1rem;
        }

        .sidebar-icon {
            font-size: 2.5rem;
            color: #fbbf24;
            text-shadow: 0 0 20px rgba(251, 191, 36, 0.5);
            animation: pulse-glow 2s infinite;
        }

        @keyframes pulse-glow {
            0%, 100% { transform: scale(1); filter: brightness(1); }
            50% { transform: scale(1.1); filter: brightness(1.3); }
        }

        .sidebar-title {
            color: #fbbf24;
            font-size: 1.25rem;
            font-weight: 700;
            text-align: center;
        }

        .sidebar-subtitle {
            color: #94a3b8;
            font-size: 0.85rem;
            margin-top: 0.5rem;
        }

        .sidebar-nav {
            padding: 1rem 0;
        }

        .nav-item {
            margin: 0.25rem 1rem;
            border-radius: 0.75rem;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .nav-link {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem 1.5rem;
            color: #cbd5e1;
            text-decoration: none;
            font-weight: 500;
            transition: all 0.3s ease;
            border-radius: 0.75rem;
        }

        .nav-link:hover {
            background: rgba(251, 191, 36, 0.1);
            color: #fbbf24;
            transform: translateX(5px);
        }

        .nav-link.active {
            background: linear-gradient(135deg, rgba(251, 191, 36, 0.2), rgba(245, 158, 11, 0.1));
            color: #fbbf24;
            border: 1px solid rgba(251, 191, 36, 0.3);
            box-shadow: 0 4px 15px rgba(251, 191, 36, 0.2);
        }

        .nav-icon {
            font-size: 1.25rem;
            min-width: 1.5rem;
            text-align: center;
        }

        /* User Profile */
        .sidebar-user {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 1.5rem;
            border-top: 1px solid rgba(251, 191, 36, 0.2);
            background: rgba(15, 23, 42, 0.5);
        }

        .user-profile {
            display: flex;
            align-items: center;
            gap: 1rem;
            cursor: pointer;
            padding: 0.75rem;
            border-radius: 0.75rem;
            transition: all 0.3s ease;
        }

        .user-profile:hover {
            background: rgba(251, 191, 36, 0.1);
        }

        .user-avatar {
            width: 3rem;
            height: 3rem;
            border-radius: 50%;
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 1.2rem;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
        }

        .user-info h4 {
            color: #f8fafc;
            font-size: 0.95rem;
            font-weight: 600;
            margin: 0;
        }

        .user-info p {
            color: #94a3b8;
            font-size: 0.8rem;
            margin: 0;
        }

        /* Main Content */
        .main-content {
            margin-left: 280px;
            min-height: 100vh;
            padding: 2rem;
            transition: all 0.3s ease;
        }

        .content-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid rgba(251, 191, 36, 0.2);
        }

        .page-title {
            font-size: 2rem;
            font-weight: 700;
            color: #fbbf24;
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .page-icon {
            font-size: 2.5rem;
            color: #f59e0b;
        }

        /* Cards */
        .card {
            background: linear-gradient(135deg, rgba(30, 41, 59, 0.9), rgba(51, 65, 85, 0.7));
            border: 1px solid rgba(251, 191, 36, 0.2);
            border-radius: 1rem;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
            overflow: hidden;
            position: relative;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 40px rgba(251, 191, 36, 0.2);
            border-color: rgba(251, 191, 36, 0.4);
        }

        .card::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, transparent, rgba(251, 191, 36, 0.1), transparent);
            transform: rotate(45deg);
            transition: all 0.6s ease;
            opacity: 0;
        }

        .card:hover::before {
            opacity: 1;
            animation: shine 0.6s ease-in-out;
        }

        @keyframes shine {
            0% { transform: translateX(-100%) translateY(-100%) rotate(45deg); }
            100% { transform: translateX(100%) translateY(100%) rotate(45deg); }
        }

        .card-header {
            padding: 1.5rem;
            border-bottom: 1px solid rgba(251, 191, 36, 0.2);
            background: rgba(251, 191, 36, 0.05);
        }

        .card-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: #fbbf24;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .card-body {
            padding: 1.5rem;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: linear-gradient(135deg, rgba(30, 41, 59, 0.9), rgba(51, 65, 85, 0.7));
            border: 1px solid rgba(251, 191, 36, 0.2);
            border-radius: 1rem;
            padding: 2rem;
            text-align: center;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .stat-card:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: 0 20px 40px rgba(251, 191, 36, 0.3);
            border-color: rgba(251, 191, 36, 0.6);
        }

        .stat-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
            display: block;
        }

        .stat-icon.primary { color: #fbbf24; }
        .stat-icon.success { color: #10b981; }
        .stat-icon.warning { color: #f59e0b; }
        .stat-icon.danger { color: #ef4444; }
        .stat-icon.info { color: #3b82f6; }

        .stat-value {
            font-size: 2.5rem;
            font-weight: 800;
            color: #fbbf24;
            margin-bottom: 0.5rem;
        }

        .stat-label {
            color: #94a3b8;
            font-size: 0.9rem;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Tables */
        .table-container {
            background: linear-gradient(135deg, rgba(30, 41, 59, 0.9), rgba(51, 65, 85, 0.7));
            border: 1px solid rgba(251, 191, 36, 0.2);
            border-radius: 1rem;
            overflow: hidden;
            margin-bottom: 2rem;
        }

        .table {
            margin: 0;
        }

        .table thead th {
            background: rgba(251, 191, 36, 0.1);
            color: #fbbf24;
            font-weight: 600;
            border: none;
            padding: 1rem;
        }

        .table tbody td {
            background: rgba(30, 41, 59, 0.5);
            color: #f8fafc;
            border: none;
            padding: 1rem;
            border-bottom: 1px solid rgba(148, 163, 184, 0.1);
        }

        .table tbody tr:hover {
            background: rgba(251, 191, 36, 0.1);
        }

        /* Buttons */
        .btn {
            border-radius: 0.75rem;
            font-weight: 600;
            padding: 0.75rem 1.5rem;
            border: none;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            text-decoration: none;
            cursor: pointer;
        }

        .btn-primary {
            background: linear-gradient(135deg, #fbbf24, #f59e0b);
            color: #0f172a;
            box-shadow: 0 4px 12px rgba(251, 191, 36, 0.3);
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(251, 191, 36, 0.4);
            color: #0f172a;
        }

        .btn-success {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
        }

        .btn-success:hover {
            background: linear-gradient(135deg, #059669, #047857);
            transform: translateY(-2px);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
        }

        .btn-danger:hover {
            background: linear-gradient(135deg, #dc2626, #b91c1c);
            transform: translateY(-2px);
            color: white;
        }

        .btn-secondary {
            background: rgba(148, 163, 184, 0.2);
            color: #f8fafc;
            border: 1px solid rgba(148, 163, 184, 0.3);
        }

        .btn-secondary:hover {
            background: rgba(148, 163, 184, 0.3);
            transform: translateY(-2px);
            color: #f8fafc;
        }

        .btn-warning {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            color: white;
        }

        .btn-warning:hover {
            background: linear-gradient(135deg, #d97706, #b45309);
            transform: translateY(-2px);
            color: white;
        }

        .btn-info {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: white;
        }

        .btn-info:hover {
            background: linear-gradient(135deg, #2563eb, #1d4ed8);
            transform: translateY(-2px);
            color: white;
        }

        /* Status Badges */
        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 50px;
            font-size: 0.75rem;
            font-weight: 500;
            text-transform: uppercase;
        }

        .status-pending { background: rgba(251, 191, 36, 0.2); color: #fbbf24; }
        .status-approved { background: rgba(16, 185, 129, 0.2); color: #10b981; }
        .status-progress { background: rgba(59, 130, 246, 0.2); color: #3b82f6; }
        .status-completed { background: rgba(34, 197, 94, 0.2); color: #22c55e; }
        .status-cancelled { background: rgba(239, 68, 68, 0.2); color: #ef4444; }

        /* Forms */
        .form-control {
            background: rgba(15, 23, 42, 0.5);
            border: 1px solid rgba(251, 191, 36, 0.3);
            border-radius: 0.5rem;
            color: #f8fafc;
            padding: 0.75rem 1rem;
        }

        .form-control:focus {
            background: rgba(15, 23, 42, 0.7);
            border-color: #fbbf24;
            box-shadow: 0 0 0 3px rgba(251, 191, 36, 0.2);
            color: #f8fafc;
        }

        .form-label {
            color: #f8fafc;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        /* Modals */
        .modal-content {
            background: linear-gradient(135deg, rgba(30, 41, 59, 0.95), rgba(51, 65, 85, 0.95));
            border: 1px solid rgba(251, 191, 36, 0.3);
            border-radius: 1rem;
        }

        .modal-header {
            border-bottom: 1px solid rgba(251, 191, 36, 0.2);
            background: rgba(251, 191, 36, 0.05);
        }

        .modal-title {
            color: #fbbf24;
            font-weight: 700;
        }

        .modal-body {
            color: #f8fafc;
        }

        .modal-footer {
            border-top: 1px solid rgba(251, 191, 36, 0.2);
        }

        /* Loading Spinner */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(15, 23, 42, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid rgba(251, 191, 36, 0.3);
            border-top: 5px solid #fbbf24;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Charts */
        .chart-container {
            position: relative;
            height: 400px;
            background: rgba(15, 23, 42, 0.3);
            border-radius: 1rem;
            padding: 1rem;
        }

        /* Responsive */
        @media (max-width: 1200px) {
            .sidebar {
                width: 250px;
            }
            .main-content {
                margin-left: 250px;
            }
        }

        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
            }
            .main-content {
                margin-left: 0;
            }
            .sidebar.show {
                transform: translateX(0);
            }
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(30, 41, 59, 0.5);
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(251, 191, 36, 0.5);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(251, 191, 36, 0.7);
        }

        /* Additional utility classes */
        .text-center { text-align: center; }
        .text-end { text-align: right; }
        .d-none { display: none !important; }
        .d-flex { display: flex !important; }
        .align-items-center { align-items: center; }
        .justify-content-between { justify-content: space-between; }
        .fw-bold { font-weight: bold; }
        .mb-2 { margin-bottom: 0.5rem; }
        .mb-3 { margin-bottom: 1rem; }
        .mb-4 { margin-bottom: 1.5rem; }
        .mt-2 { margin-top: 0.5rem; }
        .mt-3 { margin-top: 1rem; }
        .me-2 { margin-right: 0.5rem; }

        .btn-group {
            display: flex;
            gap: 0.25rem;
        }

        .btn-sm {
            padding: 0.375rem 0.75rem;
            font-size: 0.875rem;
        }

        .table-responsive {
            overflow-x: auto;
        }

        .row {
            display: flex;
            flex-wrap: wrap;
            margin: -0.75rem;
        }

        .col-md-3,
        .col-md-6 {
            padding: 0.75rem;
        }

        .col-md-3 { flex: 0 0 25%; max-width: 25%; }
        .col-md-6 { flex: 0 0 50%; max-width: 50%; }
        .col-12 { flex: 0 0 100%; max-width: 100%; }

        @media (max-width: 768px) {
            .col-md-3,
            .col-md-6 {
                flex: 0 0 100%;
                max-width: 100%;
            }
        }

        .g-3 > * {
            margin: 0.75rem;
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay d-none">
        <div class="spinner"></div>
    </div>

    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div class="sidebar-brand">
                <div class="sidebar-icon">‚ö°</div>
            </div>
            <h2 class="sidebar-title">‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°‡πÑ‡∏ü‡∏ü‡πâ‡∏≤</h2>
            <p class="sidebar-subtitle">‡∏≠‡∏ö‡∏ï.‡∏Ç‡πà‡∏≤‡πÉ‡∏´‡∏ç‡πà - Desktop Dashboard</p>
        </div>

        <nav class="sidebar-nav">
            <div class="nav-item">
                <a href="#" class="nav-link active" onclick="showPage('dashboard')">
                    <span class="nav-icon">üè†</span>
                    <span>‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å</span>
                </a>
            </div>
            <div class="nav-item">
                <a href="#" class="nav-link" onclick="showPage('requests')">
                    <span class="nav-icon">üîß</span>
                    <span>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏ã‡πà‡∏≠‡∏°</span>
                </a>
            </div>
            <div class="nav-item">
                <a href="#" class="nav-link" onclick="showPage('reports')">
                    <span class="nav-icon">üìä</span>
                    <span>‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡∏∞‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥</span>
                </a>
            </div>
            <div class="nav-item">
                <a href="#" class="nav-link" onclick="showPage('inventory')">
                    <span class="nav-icon">üì¶</span>
                    <span>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ñ‡∏•‡∏±‡∏á‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</span>
                </a>
            </div>
            <div class="nav-item">
                <a href="#" class="nav-link" onclick="showPage('users')">
                    <span class="nav-icon">üë•</span>
                    <span>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</span>
                </a>
            </div>
            <div class="nav-item">
                <a href="#" class="nav-link" onclick="showPage('settings')">
                    <span class="nav-icon">‚öôÔ∏è</span>
                    <span>‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡∏∞‡∏ö‡∏ö</span>
                </a>
            </div>
        </nav>

        <div class="sidebar-user">
            <div class="user-profile" onclick="showUserMenu()">
                <div class="user-avatar" id="userAvatar">A</div>
                <div class="user-info">
                    <h4 id="userName">Loading...</h4>
                    <p id="userRole">‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Dashboard Page -->
        <div id="dashboardPage">
            <div class="content-header">
                <h1 class="page-title">
                    <span class="page-icon">üè†</span>
                    ‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å - ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏£‡∏∞‡∏ö‡∏ö
                </h1>
                <div>
                    <button class="btn btn-primary" onclick="refreshData()">
                        üîÑ ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                    </button>
                </div>
            </div>

            <!-- Stats Cards -->
            <div class="stats-grid">
                <div class="stat-card">
                    <span class="stat-icon primary">üîß</span>
                    <div class="stat-value" id="totalRequests">-</div>
                    <div class="stat-label">‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏ã‡πà‡∏≠‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
                </div>
                <div class="stat-card">
                    <span class="stat-icon warning">‚è≥</span>
                    <div class="stat-value" id="pendingRequests">-</div>
                    <div class="stat-label">‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</div>
                </div>
                <div class="stat-card">
                    <span class="stat-icon info">üîß</span>
                    <div class="stat-value" id="inProgressRequests">-</div>
                    <div class="stat-label">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</div>
                </div>
                <div class="stat-card">
                    <span class="stat-icon success">‚úÖ</span>
                    <div class="stat-value" id="completedRequests">-</div>
                    <div class="stat-label">‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô‡πÅ‡∏•‡πâ‡∏ß</div>
                </div>
                <div class="stat-card">
                    <span class="stat-icon primary">üì¶</span>
                    <div class="stat-value" id="totalInventory">-</div>
                    <div class="stat-label">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡∏•‡∏±‡∏á</div>
                </div>
                <div class="stat-card">
                    <span class="stat-icon info">üë•</span>
                    <div class="stat-value" id="totalUsers">-</div>
                    <div class="stat-label">‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏£‡∏∞‡∏ö‡∏ö</div>
                </div>
            </div>

            <!-- Recent Requests -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">
                        <span>üìã</span>
                        ‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
                    </h3>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>üé´ ‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà</th>
                                    <th>üë§ ‡∏ú‡∏π‡πâ‡πÅ‡∏à‡πâ‡∏á</th>
                                    <th>üìç ‡∏õ‡∏±‡∏ç‡∏´‡∏≤</th>
                                    <th>üìä ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                                    <th>üìÖ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
                                    <th>‚öôÔ∏è ‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                                </tr>
                            </thead>
                            <tbody id="recentRequestsTable">
                                <tr>
                                    <td colspan="6" class="text-center">
                                        <div class="spinner"></div>
                                        <p class="mt-2">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Requests Page -->
        <div id="requestsPage" class="d-none">
            <div class="content-header">
                <h1 class="page-title">
                    <span class="page-icon">üîß</span>
                    ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏ã‡πà‡∏≠‡∏°
                </h1>
                <div>
                    <button class="btn btn-primary" onclick="openLookerReports()">
                        üìä ‡πÄ‡∏õ‡∏¥‡∏î Looker Studio
                    </button>
                    <button class="btn btn-success" onclick="exportRequests()">
                        üìÅ Export ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                    </button>
                    <button class="btn btn-info" onclick="exportRequestsPDF()">
                        üìÑ Export PDF
                    </button>
                </div>
            </div>

            <!-- Filters -->
            <div class="card mb-4">
                <div class="card-header">
                    <h3 class="card-title">
                        <span>üîç</span>
                        ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÅ‡∏•‡∏∞‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                    </h3>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-3">
                            <label class="form-label">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏Ñ‡∏≥‡∏Ç‡∏≠</label>
                            <input type="text" class="form-control" id="searchRequestId" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà...">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</label>
                            <select class="form-control" id="filterStatus">
                                <option value="">‡∏ó‡∏∏‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</option>
                                <option value="‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£">‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</option>
                                <option value="‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß‡∏£‡∏≠‡∏ä‡πà‡∏≤‡∏á">‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß‡∏£‡∏≠‡∏ä‡πà‡∏≤‡∏á</option>
                                <option value="‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</option>
                                <option value="‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô">‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô</option>
                                <option value="‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô</label>
                            <input type="date" class="form-control" id="filterDateFrom">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î</label>
                            <input type="date" class="form-control" id="filterDateTo">
                        </div>
                    </div>
                    <div class="mt-3">
                        <button class="btn btn-primary" onclick="filterRequests()">
                            üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
                        </button>
                        <button class="btn btn-secondary" onclick="clearFilters()">
                            üóëÔ∏è ‡∏•‡πâ‡∏≤‡∏á‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á
                        </button>
                    </div>
                </div>
            </div>

            <!-- Requests Table -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">
                        <span>üìã</span>
                        ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏ã‡πà‡∏≠‡∏°
                    </h3>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table" id="requestsTable">
                            <thead>
                                <tr>
                                    <th>üé´ ‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà</th>
                                    <th>üë§ ‡∏ú‡∏π‡πâ‡πÅ‡∏à‡πâ‡∏á</th>
                                    <th>üì± ‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£</th>
                                    <th>üóº ‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏™‡∏≤</th>
                                    <th>üìç ‡∏õ‡∏±‡∏ç‡∏´‡∏≤</th>
                                    <th>üìä ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                                    <th>üìÖ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
                                    <th>‚öôÔ∏è ‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                                </tr>
                            </thead>
                            <tbody id="requestsTableBody">
                                <!-- Dynamic content -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Reports Page -->
        <div id="reportsPage" class="d-none">
            <div class="content-header">
                <h1 class="page-title">
                    <span class="page-icon">üìä</span>
                    ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡∏∞‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥
                </h1>
                <div>
                    <button class="btn btn-primary" onclick="openLookerStudio()">
                        üìà ‡πÄ‡∏õ‡∏¥‡∏î Looker Studio
                    </button>
                    <button class="btn btn-success" onclick="sendTelegramReport()">
                        üì± ‡∏™‡πà‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô Telegram
                    </button>
                </div>
            </div>

            <!-- Quick Reports -->
            <div class="stats-grid mb-4">
                <div class="stat-card" style="cursor: pointer;" onclick="generateReport('today')">
                    <span class="stat-icon primary">üìà</span>
                    <div class="stat-value" id="todayReports">-</div>
                    <div class="stat-label">‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</div>
                </div>
                <div class="stat-card" style="cursor: pointer;" onclick="generateReport('week')">
                    <span class="stat-icon info">üìÖ</span>
                    <div class="stat-value" id="weekReports">-</div>
                    <div class="stat-label">‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏ô‡∏µ‡πâ</div>
                </div>
                <div class="stat-card" style="cursor: pointer;" onclick="generateReport('month')">
                    <span class="stat-icon warning">üìÜ</span>
                    <div class="stat-value" id="monthReports">-</div>
                    <div class="stat-label">‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</div>
                </div>
                <div class="stat-card" style="cursor: pointer;" onclick="generateReport('year')">
                    <span class="stat-icon success">üìã</span>
                    <div class="stat-value" id="yearReports">-</div>
                    <div class="stat-label">‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏õ‡∏µ‡∏ô‡∏µ‡πâ</div>
                </div>
            </div>

            <!-- Charts -->
            <div class="row">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">
                                <span>üìä</span>
                                ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏ï‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
                            </h3>
                        </div>
                        <div class="card-body">
                            <div class="chart-container">
                                <canvas id="statusChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">
                                <span>üìà</span>
                                ‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô
                            </h3>
                        </div>
                        <div class="card-body">
                            <div class="chart-container">
                                <canvas id="trendChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Inventory Page -->
        <div id="inventoryPage" class="d-none">
            <div class="content-header">
                <h1 class="page-title">
                    <span class="page-icon">üì¶</span>
                    ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ñ‡∏•‡∏±‡∏á‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå
                </h1>
                <div>
                    <button class="btn btn-primary" onclick="showAddInventoryModal()">
                        ‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà
                    </button>
                    <button class="btn btn-success" onclick="exportInventory()">
                        üìÅ Export ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                    </button>
                </div>
            </div>

            <!-- Inventory Stats -->
            <div class="stats-grid mb-4">
                <div class="stat-card">
                    <span class="stat-icon primary">üì¶</span>
                    <div class="stat-value" id="totalInventoryItems">-</div>
                    <div class="stat-label">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
                </div>
                <div class="stat-card">
                    <span class="stat-icon success">‚úÖ</span>
                    <div class="stat-value" id="inStockItems">-</div>
                    <div class="stat-label">‡∏°‡∏µ‡∏™‡∏ï‡πá‡∏≠‡∏Å</div>
                </div>
                <div class="stat-card">
                    <span class="stat-icon warning">‚ö†Ô∏è</span>
                    <div class="stat-value" id="lowStockItems">-</div>
                    <div class="stat-label">‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏ï‡πà‡∏≥</div>
                </div>
                <div class="stat-card">
                    <span class="stat-icon danger">‚ùå</span>
                    <div class="stat-value" id="outOfStockItems">-</div>
                    <div class="stat-label">‡∏´‡∏°‡∏î‡∏™‡∏ï‡πá‡∏≠‡∏Å</div>
                </div>
            </div>

            <!-- Inventory Table -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">
                        <span>üìã</span>
                        ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡πÉ‡∏ô‡∏Ñ‡∏•‡∏±‡∏á
                    </h3>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table" id="inventoryTable">
                            <thead>
                                <tr>
                                    <th>üì¶ ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th>
                                    <th>üìè ‡∏´‡∏ô‡πà‡∏ß‡∏¢</th>
                                    <th>üí∞ ‡∏£‡∏≤‡∏Ñ‡∏≤/‡∏´‡∏ô‡πà‡∏ß‡∏¢</th>
                                    <th>üìä ‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</th>
                                    <th>üìà ‡πÄ‡∏ö‡∏¥‡∏Å‡πÅ‡∏•‡πâ‡∏ß</th>
                                    <th>üí∏ ‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏£‡∏ß‡∏°</th>
                                    <th>‚öôÔ∏è ‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                                </tr>
                            </thead>
                            <tbody id="inventoryTableBody">
                                <!-- Dynamic content -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Users Page -->
        <div id="usersPage" class="d-none">
            <div class="content-header">
                <h1 class="page-title">
                    <span class="page-icon">üë•</span>
                    ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ
                </h1>
                <div>
                    <button class="btn btn-primary" onclick="showAddUserModal()">
                        ‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÉ‡∏´‡∏°‡πà
                    </button>
                </div>
            </div>

            <!-- Users Table -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">
                        <span>üìã</span>
                        ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏£‡∏∞‡∏ö‡∏ö
                    </h3>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table" id="usersTable">
                            <thead>
                                <tr>
                                    <th>üë§ ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</th>
                                    <th>üìß ‡∏≠‡∏µ‡πÄ‡∏°‡∏•</th>
                                    <th>üîë ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå</th>
                                    <th>üìä ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                                    <th>‚è∞ ‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏ä‡πâ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</th>
                                    <th>‚öôÔ∏è ‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                                </tr>
                            </thead>
                            <tbody id="usersTableBody">
                                <!-- Dynamic content -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Settings Page -->
        <div id="settingsPage" class="d-none">
            <div class="content-header">
                <h1 class="page-title">
                    <span class="page-icon">‚öôÔ∏è</span>
                    ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡∏∞‡∏ö‡∏ö
                </h1>
            </div>

            <!-- Telegram Settings -->
            <div class="card mb-4">
                <div class="card-header">
                    <h3 class="card-title">
                        <span>üì±</span>
                        ‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô Telegram
                    </h3>
                </div>
                <div class="card-body">
                    <form id="telegramForm">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">Bot Token</label>
                                <input type="text" class="form-control" id="botToken" placeholder="‡πÉ‡∏™‡πà Bot Token">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Chat ID</label>
                                <input type="text" class="form-control" id="chatId" placeholder="‡πÉ‡∏™‡πà Chat ID">
                            </div>
                            <div class="col-12">
                                <div class="form-check">
                                    <input type="checkbox" class="form-check-input" id="enableTelegram">
                                    <label class="form-check-label" for="enableTelegram">
                                        ‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô Telegram
                                    </label>
                                </div>
                            </div>
                        </div>
                        <div class="mt-3">
                            <button type="submit" class="btn btn-primary">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                            <button type="button" class="btn btn-secondary" onclick="testTelegram()">üß™ ‡∏ó‡∏î‡∏™‡∏≠‡∏ö</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- System Info -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">
                        <span>‚ÑπÔ∏è</span>
                        ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏∞‡∏ö‡∏ö
                    </h3>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <p><strong>‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô‡∏£‡∏∞‡∏ö‡∏ö:</strong> 2.0.0</p>
                            <p><strong>‡πÅ‡∏û‡∏•‡∏ï‡∏ü‡∏≠‡∏£‡πå‡∏°:</strong> Desktop Web Application</p>
                            <p><strong>‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•:</strong> Google Sheets</p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô:</strong> Google Looker Studio</p>
                            <p><strong>‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô:</strong> Telegram Bot</p>
                            <p><strong>‡∏Å‡∏≤‡∏£‡∏û‡∏¥‡∏°‡∏û‡πå:</strong> PDF Export</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Inventory Modal -->
    <div class="modal fade" id="addInventoryModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">üì¶ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡πÉ‡∏´‡∏°‡πà</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="addInventoryForm">
                        <div class="mb-3">
                            <label class="form-label">‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</label>
                            <input type="text" class="form-control" id="newItemName" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">‡∏´‡∏ô‡πà‡∏ß‡∏¢</label>
                            <input type="text" class="form-control" id="newItemUnit" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡πà‡∏≠‡∏´‡∏ô‡πà‡∏ß‡∏¢</label>
                            <input type="number" class="form-control" id="newItemPrice" step="0.01" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô</label>
                            <input type="number" class="form-control" id="newItemStock" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                    <button type="button" class="btn btn-primary" onclick="saveNewInventoryItem()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add User Modal -->
    <div class="modal fade" id="addUserModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">üë§ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÉ‡∏´‡∏°‡πà</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="addUserForm">
                        <div class="mb-3">
                            <label class="form-label">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</label>
                            <input type="text" class="form-control" id="newUsername" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</label>
                            <input type="password" class="form-control" id="newPassword" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏ï‡πá‡∏°</label>
                            <input type="text" class="form-control" id="newFullName">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">‡∏≠‡∏µ‡πÄ‡∏°‡∏•</label>
                            <input type="email" class="form-control" id="newEmail">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</label>
                            <select class="form-control" id="newRole" required>
                                <option value="technician">‡∏ä‡πà‡∏≤‡∏á‡πÄ‡∏ó‡∏Ñ‡∏ô‡∏¥‡∏Ñ</option>
                                <option value="executive">‡∏ú‡∏π‡πâ‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£</option>
                                <option value="admin">‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input" id="newIsActive" checked>
                                <label class="form-check-label" for="newIsActive">
                                    ‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô
                                </label>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                    <button type="button" class="btn btn-primary" onclick="saveNewUser()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Inventory Modal -->
    <div class="modal fade" id="editInventoryModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editInventoryForm">
                        <input type="hidden" id="editOriginalItemName">
                        <div class="mb-3">
                            <label class="form-label">‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</label>
                            <input type="text" class="form-control" id="editItemName" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">‡∏´‡∏ô‡πà‡∏ß‡∏¢</label>
                            <input type="text" class="form-control" id="editItemUnit" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡πà‡∏≠‡∏´‡∏ô‡πà‡∏ß‡∏¢</label>
                            <input type="number" class="form-control" id="editItemPrice" step="0.01" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                    <button type="button" class="btn btn-primary" onclick="saveEditInventoryItem()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Adjust Inventory Modal -->
    <div class="modal fade" id="adjustInventoryModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="adjustModalTitle">üìä ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏™‡∏ï‡πá‡∏≠‡∏Å</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="adjustInventoryForm">
                        <input type="hidden" id="adjustItemName">
                        <input type="hidden" id="adjustType">
                        <div class="mb-3">
                            <label class="form-label">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</label>
                            <input type="text" class="form-control" id="adjustItemNameDisplay" readonly>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</label>
                            <input type="number" class="form-control" id="adjustQuantity" required min="1">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</label>
                            <textarea class="form-control" id="adjustNotes" rows="3"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                    <button type="button" class="btn btn-primary" onclick="saveAdjustInventory()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Update Request Status Modal -->
    <div class="modal fade" id="updateStatusModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">üìä ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ñ‡∏≥‡∏Ç‡∏≠</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="updateStatusForm">
                        <input type="hidden" id="updateRequestId">
                        <div class="mb-3">
                            <label class="form-label">‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏Ñ‡∏≥‡∏Ç‡∏≠</label>
                            <input type="text" class="form-control" id="updateRequestIdDisplay" readonly>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÉ‡∏´‡∏°‡πà</label>
                            <select class="form-control" id="updateNewStatus" required>
                                <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</option>
                                <option value="‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£">‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</option>
                                <option value="‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß‡∏£‡∏≠‡∏ä‡πà‡∏≤‡∏á">‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß‡∏£‡∏≠‡∏ä‡πà‡∏≤‡∏á</option>
                                <option value="‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</option>
                                <option value="‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô">‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô</option>
                                <option value="‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</option>
                                <option value="‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÇ‡∏î‡∏¢‡∏ú‡∏π‡πâ‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£">‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÇ‡∏î‡∏¢‡∏ú‡∏π‡πâ‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡∏ä‡πà‡∏≤‡∏á</label>
                            <textarea class="form-control" id="updateTechnicianNotes" rows="3"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                    <button type="button" class="btn btn-primary" onclick="saveUpdateStatus()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- DataTables JS -->
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.7.0/dist/jquery.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
    
    <!-- SweetAlert2 JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/limonte-sweetalert2/11.10.1/sweetalert2.min.js"></script>
    
    <!-- Auth Utils -->
    <script src="/auth-utils.js"></script>

    <script>
        // Global Variables
        let currentUser = null;
        let allRequests = [];
        let allInventory = [];
        let allUsers = [];
        let statusChart = null;
        let trendChart = null;
        let lookerStudioUrl = '';
        let currentRequestsData = [];

        // Initialize App
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
        });

        async function initializeApp() {
            console.log('Initializing Dashboard App...');
            
            // Check if AuthUtils is loaded
            if (!window.AuthUtils) {
                console.error('AuthUtils not loaded');
                window.location.href = '/admin/smart-login.html?message=' + encodeURIComponent('‡∏£‡∏∞‡∏ö‡∏ö‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏° ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á');
                return;
            }
            
            // Debug authentication state
            window.AuthUtils.debugAuth();
            
            // Check authentication first
            if (!window.AuthUtils.protectPage(['admin', 'executive', 'technician'])) {
                console.warn('Authentication failed, redirecting to login');
                return;
            }

            const authUser = window.AuthUtils.getCurrentUser();
            console.log('Current authenticated user:', authUser);
            
            if (authUser && authUser.user) {
                currentUser = {
                    username: authUser.user.username,
                    role: authUser.user.role,
                    token: authUser.token,
                    system: authUser.system
                };
                
                console.log('User authenticated successfully:', currentUser);
                
                updateUserDisplay();
                
                try {
                    await loadLookerConfig();
                    await loadDashboardData();
                    showToast('‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö‡∏™‡∏π‡πà Desktop Dashboard! ‚ö°', 'success');
                } catch (error) {
                    console.error('Error loading dashboard data:', error);
                    showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: ' + error.message, 'error');
                }
            } else {
                console.error('No valid user data found');
                window.AuthUtils.forceLogout('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ');
            }
        }

        function updateUserDisplay() {
            if (currentUser) {
                const userNameElement = document.getElementById('userName');
                const userRoleElement = document.getElementById('userRole');
                const userAvatarElement = document.getElementById('userAvatar');
                
                if (userNameElement) {
                    userNameElement.textContent = currentUser.username;
                }
                
                if (userRoleElement) {
                    userRoleElement.textContent = getRoleDisplayName(currentUser.role);
                }
                
                if (userAvatarElement) {
                    userAvatarElement.textContent = currentUser.username.charAt(0).toUpperCase();
                }
                
                console.log('User display updated:', {
                    username: currentUser.username,
                    role: currentUser.role,
                    system: currentUser.system
                });
            } else {
                console.warn('No current user to display');
            }
        }

        async function safeApiCall(url, options = {}) {
            try {
                if (!window.AuthUtils.isAuthenticated()) {
                    throw new Error('Not authenticated');
                }
                
                const response = await window.AuthUtils.apiCall(url, options);
                return response;
            } catch (error) {
                console.error('API call failed:', error);
                
                if (error.message.includes('authenticated') || error.message.includes('Unauthorized')) {
                    window.AuthUtils.forceLogout('‡πÄ‡∏ã‡∏™‡∏ä‡∏±‡∏ô‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏´‡∏°‡πà');
                    throw error;
                }
                
                throw error;
            }
        }

        function getRoleDisplayName(role) {
            const roles = {
                'admin': '‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö',
                'executive': '‡∏ú‡∏π‡πâ‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£',
                'technician': '‡∏ä‡πà‡∏≤‡∏á‡πÄ‡∏ó‡∏Ñ‡∏ô‡∏¥‡∏Ñ'
            };
            return roles[role] || role;
        }

        function showLoading(show = true) {
            const overlay = document.getElementById('loadingOverlay');
            if (show) {
                overlay.classList.remove('d-none');
            } else {
                overlay.classList.add('d-none');
            }
        }

        // Load Looker Studio Configuration
        async function loadLookerConfig() {
            try {
                const response = await safeApiCall('/api/admin/config/looker-url');
                const data = await response.json();
                
                if (data.status === 'success' && data.data && data.data.lookerUrl) {
                    lookerStudioUrl = data.data.lookerUrl;
                    console.log('Looker Studio URL loaded:', lookerStudioUrl);
                } else {
                    console.warn('‡πÑ‡∏°‡πà‡∏û‡∏ö Looker Studio URL ‡πÉ‡∏ô config');
                    lookerStudioUrl = '#';
                }
            } catch (error) {
                console.error('Error loading Looker config:', error);
                lookerStudioUrl = '#';
            }
        }

        // Load Dashboard Data
        async function loadDashboardData() {
            try {
                showLoading(true);
                showToast('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏∞‡∏ö‡∏ö...', 'info');
                
                await Promise.all([
                    loadStats(),
                    loadRecentRequests()
                ]);
                
                showToast('‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! üìä', 'success');
            } catch (error) {
                console.error('Error loading dashboard data:', error);
                showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        async function loadStats() {
            try {
                // Load repair requests
                const requestsResponse = await safeApiCall('/api/admin/repair-requests?limit=1000');
                const requestsData = await requestsResponse.json();
                
                if (requestsData.status === 'success') {
                    allRequests = requestsData.data || [];
                    
                    const total = allRequests.length;
                    const pending = allRequests.filter(r => r.STATUS === '‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£' || r.STATUS === '‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß‡∏£‡∏≠‡∏ä‡πà‡∏≤‡∏á').length;
                    const inProgress = allRequests.filter(r => r.STATUS === '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£').length;
                    const completed = allRequests.filter(r => r.STATUS === '‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô').length;
                    
                    document.getElementById('totalRequests').textContent = total;
                    document.getElementById('pendingRequests').textContent = pending;
                    document.getElementById('inProgressRequests').textContent = inProgress;
                    document.getElementById('completedRequests').textContent = completed;
                }

                // Load inventory
                try {
                    const inventoryResponse = await safeApiCall('/api/admin/inventory');
                    const inventoryData = await inventoryResponse.json();
                    
                    if (inventoryData.status === 'success') {
                        allInventory = inventoryData.data || [];
                        document.getElementById('totalInventory').textContent = allInventory.length;
                    }
                } catch (e) {
                    console.warn('Could not load inventory:', e);
                    document.getElementById('totalInventory').textContent = '0';
                }

                // Load users
                try {
                    const usersResponse = await safeApiCall('/api/admin/users');
                    const usersData = await usersResponse.json();
                    
                    if (usersData.status === 'success') {
                        allUsers = usersData.data || [];
                        document.getElementById('totalUsers').textContent = allUsers.length;
                    }
                } catch (e) {
                    console.warn('Could not load users:', e);
                    document.getElementById('totalUsers').textContent = '0';
                }

                console.log('Stats loaded successfully');
            } catch (error) {
                console.error('Error loading stats:', error);
                throw error;
            }
        }

        async function loadRecentRequests() {
            try {
                const tbody = document.getElementById('recentRequestsTable');
                
                if (allRequests.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="6" class="text-center text-muted">
                                <p>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏≥‡∏Ç‡∏≠</p>
                            </td>
                        </tr>
                    `;
                    return;
                }

                const recentRequests = allRequests.slice(0, 10); // ‡πÅ‡∏™‡∏î‡∏á 10 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
                
                tbody.innerHTML = recentRequests.map(request => {
                    const fullName = `${request.FIRST_NAME || ''} ${request.LAST_NAME || ''}`.trim() || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
                    const statusBadge = getStatusBadge(request.STATUS);
                    const dateReported = formatThaiDate(request.DATE_REPORTED);
                    
                    return `
                        <tr>
                            <td class="fw-bold text-warning">${request.REQUEST_ID}</td>
                            <td>${fullName}</td>
                            <td style="max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                                ${request.PROBLEM_DESCRIPTION || request.REASON || '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î'}
                            </td>
                            <td>${statusBadge}</td>
                            <td>${dateReported}</td>
                            <td>
                                <button class="btn btn-sm btn-primary" onclick="viewRequestDetails('${request.REQUEST_ID}')">
                                    üëÅÔ∏è ‡∏î‡∏π
                                </button>
                                <button class="btn btn-sm btn-secondary" onclick="printRequest('${request.REQUEST_ID}')">
                                    üñ®Ô∏è ‡∏û‡∏¥‡∏°‡∏û‡πå
                                </button>
                            </td>
                        </tr>
                    `;
                }).join('');

            } catch (error) {
                console.error('Error loading recent requests:', error);
                document.getElementById('recentRequestsTable').innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center text-danger">
                            <p>‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p>
                        </td>
                    </tr>
                `;
            }
        }

        function formatThaiDate(dateString) {
            if (!dateString) return '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
            
            try {
                // Handle Thai format: DD/MM/YYYY, HH:MM:SS
                if (dateString.includes('/')) {
                    const parts = dateString.split(',');
                    const datePart = parts[0].trim();
                    return datePart; // Return only date part
                }
                
                // Handle ISO format
                const date = new Date(dateString);
                return date.toLocaleDateString('th-TH');
            } catch (error) {
                return dateString;
            }
        }

        function getStatusBadge(status) {
            const statusConfig = {
                '‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£': 'status-pending',
                '‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß‡∏£‡∏≠‡∏ä‡πà‡∏≤‡∏á': 'status-approved',
                '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£': 'status-progress',
                '‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô': 'status-completed',
                '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å': 'status-cancelled',
                '‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÇ‡∏î‡∏¢‡∏ú‡∏π‡πâ‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£': 'status-cancelled'
            };
            
            const className = statusConfig[status] || 'status-pending';
            return `<span class="status-badge ${className}">${status || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}</span>`;
        }

        // Navigation Functions
        function showPage(pageId) {
            // Hide all pages
            const pages = ['dashboardPage', 'requestsPage', 'reportsPage', 'inventoryPage', 'usersPage', 'settingsPage'];
            pages.forEach(page => {
                const element = document.getElementById(page);
                if (element) element.classList.add('d-none');
            });
            
            // Show selected page
            const selectedPage = document.getElementById(pageId + 'Page');
            if (selectedPage) selectedPage.classList.remove('d-none');
            
            // Update navigation
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
            });
            event.target.closest('.nav-link').classList.add('active');
            
            // Load page-specific data
            switch(pageId) {
                case 'requests':
                    loadRequestsPage();
                    break;
                case 'reports':
                    loadReportsPage();
                    break;
                case 'inventory':
                    loadInventoryPage();
                    break;
                case 'users':
                    loadUsersPage();
                    break;
                case 'settings':
                    loadSettingsPage();
                    break;
            }
        }

        // Requests Page Functions
        async function loadRequestsPage() {
            try {
                const tbody = document.getElementById('requestsTableBody');
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" class="text-center">
                            <div class="spinner"></div>
                            <p class="mt-2">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏≥‡∏Ç‡∏≠...</p>
                        </td>
                    </tr>
                `;

                // Reload requests if needed
                if (allRequests.length === 0) {
                    await loadStats();
                }

                currentRequestsData = [...allRequests];
                renderRequestsTable(currentRequestsData);
            } catch (error) {
                console.error('Error loading requests page:', error);
                showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏≥‡∏Ç‡∏≠', 'error');
            }
        }

        function renderRequestsTable(requests) {
            const tbody = document.getElementById('requestsTableBody');
            
            if (requests.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" class="text-center text-muted">
                            <p>‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏≥‡∏Ç‡∏≠</p>
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = requests.map(request => {
                const fullName = `${request.FIRST_NAME || ''} ${request.LAST_NAME || ''}`.trim() || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
                const statusBadge = getStatusBadge(request.STATUS);
                const dateReported = formatThaiDate(request.DATE_REPORTED);
                
                return `
                    <tr>
                        <td class="fw-bold text-warning">${request.REQUEST_ID}</td>
                        <td>${fullName}</td>
                        <td>${request.PHONE || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}</td>
                        <td>${request.POLE_ID || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}</td>
                        <td style="max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                            ${request.PROBLEM_DESCRIPTION || request.REASON || '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î'}
                        </td>
                        <td>${statusBadge}</td>
                        <td>${dateReported}</td>
                        <td>
                            <div class="btn-group" role="group">
                                <button class="btn btn-sm btn-primary" onclick="viewRequestDetails('${request.REQUEST_ID}')">
                                    üëÅÔ∏è ‡∏î‡∏π
                                </button>
                                <button class="btn btn-sm btn-secondary" onclick="printRequest('${request.REQUEST_ID}')">
                                    üñ®Ô∏è ‡∏û‡∏¥‡∏°‡∏û‡πå
                                </button>
                                <button class="btn btn-sm btn-success" onclick="updateRequestStatus('${request.REQUEST_ID}')">
                                    ‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Filter Functions
        function filterRequests() {
            const searchTerm = document.getElementById('searchRequestId').value.toLowerCase();
            const statusFilter = document.getElementById('filterStatus').value;
            const dateFrom = document.getElementById('filterDateFrom').value;
            const dateTo = document.getElementById('filterDateTo').value;

            let filteredRequests = [...allRequests];

            if (searchTerm) {
                filteredRequests = filteredRequests.filter(r => 
                    r.REQUEST_ID && r.REQUEST_ID.toLowerCase().includes(searchTerm)
                );
            }

            if (statusFilter) {
                filteredRequests = filteredRequests.filter(r => r.STATUS === statusFilter);
            }

            if (dateFrom) {
                const fromDate = new Date(dateFrom);
                filteredRequests = filteredRequests.filter(r => {
                    const reqDate = parseThaiDate(r.DATE_REPORTED);
                    return reqDate >= fromDate;
                });
            }

            if (dateTo) {
                const toDate = new Date(dateTo);
                toDate.setHours(23, 59, 59, 999);
                filteredRequests = filteredRequests.filter(r => {
                    const reqDate = parseThaiDate(r.DATE_REPORTED);
                    return reqDate <= toDate;
                });
            }

            currentRequestsData = filteredRequests;
            renderRequestsTable(filteredRequests);
            showToast(`‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ${filteredRequests.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`, 'success');
        }

        function clearFilters() {
            document.getElementById('searchRequestId').value = '';
            document.getElementById('filterStatus').value = '';
            document.getElementById('filterDateFrom').value = '';
            document.getElementById('filterDateTo').value = '';
            currentRequestsData = [...allRequests];
            renderRequestsTable(allRequests);
            showToast('‡∏•‡πâ‡∏≤‡∏á‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß', 'info');
        }

        function parseThaiDate(dateString) {
            if (!dateString) return new Date(0);
            
            try {
                if (dateString.includes('/')) {
                    const parts = dateString.split(',');
                    const datePart = parts[0].trim();
                    const [day, month, year] = datePart.split('/');
                    let fullYear = parseInt(year);
                    if (fullYear > 2500) fullYear -= 543;
                    return new Date(fullYear, parseInt(month) - 1, parseInt(day));
                }
                return new Date(dateString);
            } catch (error) {
                return new Date(0);
            }
        }

        // Reports Page Functions
        async function loadReportsPage() {
            try {
                // Calculate report stats
                const today = new Date();
                const todayStr = today.toISOString().split('T')[0];
                const weekStart = new Date(today.getFullYear(), today.getMonth(), today.getDate() - today.getDay());
                const monthStart = new Date(today.getFullYear(), today.getMonth(), 1);
                const yearStart = new Date(today.getFullYear(), 0, 1);

                const todayCount = allRequests.filter(r => {
                    const reqDate = parseThaiDate(r.DATE_REPORTED);
                    return reqDate.toDateString() === today.toDateString();
                }).length;

                const weekCount = allRequests.filter(r => {
                    const reqDate = parseThaiDate(r.DATE_REPORTED);
                    return reqDate >= weekStart;
                }).length;

                const monthCount = allRequests.filter(r => {
                    const reqDate = parseThaiDate(r.DATE_REPORTED);
                    return reqDate >= monthStart;
                }).length;

                const yearCount = allRequests.filter(r => {
                    const reqDate = parseThaiDate(r.DATE_REPORTED);
                    return reqDate >= yearStart;
                }).length;

                document.getElementById('todayReports').textContent = todayCount;
                document.getElementById('weekReports').textContent = weekCount;
                document.getElementById('monthReports').textContent = monthCount;
                document.getElementById('yearReports').textContent = yearCount;

                // Generate charts
                generateStatusChart();
                generateTrendChart();

            } catch (error) {
                console.error('Error loading reports page:', error);
            }
        }

        function generateStatusChart() {
            const ctx = document.getElementById('statusChart').getContext('2d');
            
            if (statusChart) {
                statusChart.destroy();
            }

            const pending = allRequests.filter(r => r.STATUS === '‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£' || r.STATUS === '‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß‡∏£‡∏≠‡∏ä‡πà‡∏≤‡∏á').length;
            const inProgress = allRequests.filter(r => r.STATUS === '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£').length;
            const completed = allRequests.filter(r => r.STATUS === '‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô').length;
            const cancelled = allRequests.filter(r => r.STATUS === '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å' || r.STATUS === '‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÇ‡∏î‡∏¢‡∏ú‡∏π‡πâ‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£').length;

            statusChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£', '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£', '‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô', '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å'],
                    datasets: [{
                        data: [pending, inProgress, completed, cancelled],
                        backgroundColor: ['#fbbf24', '#f59e0b', '#10b981', '#ef4444'],
                        borderColor: ['#f59e0b', '#d97706', '#059669', '#dc2626'],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                color: '#f8fafc',
                                font: { size: 12 }
                            }
                        }
                    }
                }
            });
        }

        function generateTrendChart() {
            const ctx = document.getElementById('trendChart').getContext('2d');
            
            if (trendChart) {
                trendChart.destroy();
            }

            // Generate monthly data for last 6 months
            const monthlyData = {};
            const now = new Date();
            
            for (let i = 5; i >= 0; i--) {
                const date = new Date(now.getFullYear(), now.getMonth() - i, 1);
                const monthKey = date.toISOString().substring(0, 7);
                monthlyData[monthKey] = 0;
            }

            allRequests.forEach(request => {
                const reqDate = parseThaiDate(request.DATE_REPORTED);
                const month = reqDate.toISOString().substring(0, 7);
                if (monthlyData.hasOwnProperty(month)) {
                    monthlyData[month]++;
                }
            });

            const labels = Object.keys(monthlyData).map(month => {
                const date = new Date(month + '-01');
                return date.toLocaleDateString('th-TH', { month: 'short', year: 'numeric' });
            });
            const data = Object.values(monthlyData);

            trendChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏≥‡∏Ç‡∏≠',
                        data: data,
                        borderColor: '#fbbf24',
                        backgroundColor: 'rgba(251, 191, 36, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: {
                                color: '#f8fafc',
                                font: { size: 12 }
                            }
                        }
                    },
                    scales: {
                        x: {
                            ticks: { color: '#94a3b8' },
                            grid: { color: 'rgba(148, 163, 184, 0.2)' }
                        },
                        y: {
                            ticks: { color: '#94a3b8' },
                            grid: { color: 'rgba(148, 163, 184, 0.2)' }
                        }
                    }
                }
            });
        }

        // Inventory Page Functions
        async function loadInventoryPage() {
            try {
                const tbody = document.getElementById('inventoryTableBody');
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="text-center">
                            <div class="spinner"></div>
                            <p class="mt-2">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏•‡∏±‡∏á...</p>
                        </td>
                    </tr>
                `;

                // Load inventory if needed
                if (allInventory.length === 0) {
                    const response = await safeApiCall('/api/admin/inventory');
                    const data = await response.json();
                    if (data.status === 'success') {
                        allInventory = data.data || [];
                    }
                }

                updateInventoryStats();
                renderInventoryTable();

            } catch (error) {
                console.error('Error loading inventory page:', error);
                showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏•‡∏±‡∏á', 'error');
            }
        }

        function updateInventoryStats() {
            const total = allInventory.length;
            const inStock = allInventory.filter(item => (item.CURRENT_STOCK || 0) > 0).length;
            const lowStock = allInventory.filter(item => {
                const stock = item.CURRENT_STOCK || 0;
                return stock > 0 && stock <= 10;
            }).length;
            const outOfStock = allInventory.filter(item => (item.CURRENT_STOCK || 0) <= 0).length;

            document.getElementById('totalInventoryItems').textContent = total;
            document.getElementById('inStockItems').textContent = inStock;
            document.getElementById('lowStockItems').textContent = lowStock;
            document.getElementById('outOfStockItems').textContent = outOfStock;
        }

        function renderInventoryTable() {
            const tbody = document.getElementById('inventoryTableBody');
            
            if (allInventory.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="text-center text-muted">
                            <p>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏•‡∏±‡∏á‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</p>
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = allInventory.map(item => {
                const currentStock = item.CURRENT_STOCK || 0;
                const pricePerUnit = item.PRICE_PER_UNIT || 0;
                const usedQuantity = item.USED_QUANTITY || 0;
                const totalValue = currentStock * pricePerUnit;
                
                let stockClass = 'text-success';
                if (currentStock <= 0) stockClass = 'text-danger';
                else if (currentStock <= 10) stockClass = 'text-warning';

                return `
                    <tr>
                        <td class="fw-bold">${item.ITEM_NAME}</td>
                        <td>${item.UNIT || '‡∏ä‡∏¥‡πâ‡∏ô'}</td>
                        <td class="text-end">${pricePerUnit.toLocaleString()} ‡∏ö‡∏≤‡∏ó</td>
                        <td class="text-end ${stockClass}">${currentStock.toLocaleString()}</td>
                        <td class="text-end">${usedQuantity.toLocaleString()}</td>
                        <td class="text-end fw-bold">${totalValue.toLocaleString()} ‡∏ö‡∏≤‡∏ó</td>
                        <td>
                            <div class="btn-group" role="group">
                                <button class="btn btn-sm btn-primary" onclick="editInventoryItem('${item.ITEM_NAME}')">
                                    ‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
                                </button>
                                <button class="btn btn-sm btn-success" onclick="adjustInventory('${item.ITEM_NAME}', 'add')">
                                    ‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°
                                </button>
                                <button class="btn btn-sm btn-warning" onclick="adjustInventory('${item.ITEM_NAME}', 'use')">
                                    ‚ûñ ‡πÄ‡∏ö‡∏¥‡∏Å
                                </button>
                                <button class="btn btn-sm btn-danger" onclick="deleteInventoryItem('${item.ITEM_NAME}')">
                                    üóëÔ∏è ‡∏•‡∏ö
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Users Page Functions
        async function loadUsersPage() {
            try {
                const tbody = document.getElementById('usersTableBody');
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center">
                            <div class="spinner"></div>
                            <p class="mt-2">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ...</p>
                        </td>
                    </tr>
                `;

                // Load users if needed
                if (allUsers.length === 0) {
                    const response = await safeApiCall('/api/admin/users');
                    const data = await response.json();
                    if (data.status === 'success') {
                        allUsers = data.data || [];
                    }
                }

                renderUsersTable();

            } catch (error) {
                console.error('Error loading users page:', error);
                showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ', 'error');
            }
        }

        function renderUsersTable() {
            const tbody = document.getElementById('usersTableBody');
            
            if (allUsers.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center text-muted">
                            <p>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</p>
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = allUsers.map(user => {
                const roleIcon = user.ROLE === 'admin' ? 'üëë' : user.ROLE === 'executive' ? 'üëî' : 'üîß';
                const statusBadge = user.IS_ACTIVE === 'TRUE' 
                    ? '<span class="status-badge status-completed">üü¢ ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏≠‡∏¢‡∏π‡πà</span>'
                    : '<span class="status-badge status-cancelled">üî¥ ‡∏£‡∏∞‡∏á‡∏±‡∏ö</span>';
                const lastLogin = user.LAST_LOGIN || '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏Ñ‡∏¢‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏ä‡πâ';

                return `
                    <tr>
                        <td>
                            <div class="d-flex align-items-center">
                                <div class="user-avatar me-2" style="width: 40px; height: 40px; font-size: 1rem;">
                                    ${user.USERNAME.charAt(0).toUpperCase()}
                                </div>
                                <div>
                                    <div class="fw-bold">${user.USERNAME}</div>
                                    <small class="text-muted">${user.FULL_NAME || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}</small>
                                </div>
                            </div>
                        </td>
                        <td>${user.EMAIL || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}</td>
                        <td>
                            <span class="status-badge status-approved">
                                ${roleIcon} ${getRoleDisplayName(user.ROLE)}
                            </span>
                        </td>
                        <td>${statusBadge}</td>
                        <td>${lastLogin}</td>
                        <td>
                            <div class="btn-group" role="group">
                                <button class="btn btn-sm btn-primary" onclick="editUser('${user.USERNAME}')">
                                    ‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
                                </button>
                                ${user.USERNAME !== currentUser.username ? `
                                    <button class="btn btn-sm btn-danger" onclick="deleteUser('${user.USERNAME}')">
                                        üóëÔ∏è ‡∏•‡∏ö
                                    </button>
                                ` : ''}
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Settings Page Functions
        async function loadSettingsPage() {
            try {
                const response = await safeApiCall('/api/admin/telegram-config');
                const data = await response.json();
                
                if (data.status === 'success' && data.data) {
                    document.getElementById('botToken').value = data.data.botToken || '';
                    document.getElementById('chatId').value = data.data.chatId || '';
                    document.getElementById('enableTelegram').checked = data.data.isEnabled || false;
                }
            } catch (error) {
                console.error('Error loading Telegram settings:', error);
            }
        }

        // Action Functions
        function viewRequestDetails(requestId) {
            const request = allRequests.find(r => r.REQUEST_ID === requestId);
            if (!request) return;

            const fullName = `${request.FIRST_NAME || ''} ${request.LAST_NAME || ''}`.trim() || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
            
            Swal.fire({
                title: `üé´ ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Ñ‡∏≥‡∏Ç‡∏≠: ${requestId}`,
                html: `
                    <div class="text-start">
                        <p><strong>üë§ ‡∏ú‡∏π‡πâ‡πÅ‡∏à‡πâ‡∏á:</strong> ${fullName}</p>
                        <p><strong>üì± ‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£:</strong> ${request.PHONE || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}</p>
                        <p><strong>üóº ‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏™‡∏≤:</strong> ${request.POLE_ID || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}</p>
                        <p><strong>üìç ‡∏õ‡∏±‡∏ç‡∏´‡∏≤:</strong> ${request.PROBLEM_DESCRIPTION || request.REASON || '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î'}</p>
                        <p><strong>üìä ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞:</strong> ${getStatusBadge(request.STATUS)}</p>
                        <p><strong>üìÖ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏à‡πâ‡∏á:</strong> ${formatThaiDate(request.DATE_REPORTED)}</p>
                        ${request.TECHNICIAN_NOTES ? `<p><strong>üìù ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏:</strong> ${request.TECHNICIAN_NOTES}</p>` : ''}
                        ${request.APPROVED_BY ? `<p><strong>‚úÖ ‡∏ú‡∏π‡πâ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥:</strong> ${request.APPROVED_BY}</p>` : ''}
                        ${request.APPROVAL_TIMESTAMP ? `<p><strong>üìÖ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥:</strong> ${request.APPROVAL_TIMESTAMP}</p>` : ''}
                    </div>
                `,
                width: '600px',
                showCloseButton: true,
                showConfirmButton: false,
                customClass: {
                    popup: 'swal2-popup-custom'
                }
            });
        }

        function printRequest(requestId) {
            if (lookerStudioUrl && lookerStudioUrl !== '#') {
                // ‡πÄ‡∏õ‡∏¥‡∏î Looker Studio ‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å‡πÉ‡∏´‡πâ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏≠‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏û‡∏¥‡∏°‡∏û‡πå
                window.open(lookerStudioUrl, '_blank');
                showToast(`‡πÄ‡∏õ‡∏¥‡∏î Looker Studio ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡∏≥‡∏Ç‡∏≠: ${requestId}`, 'success');
            } else {
                // Try PDF export instead
                printRequestAsPDF(requestId);
            }
        }

        async function printRequestAsPDF(requestId) {
            try {
                showLoading(true);
                const response = await safeApiCall(`/api/admin/request/${requestId}/pdf`, {
                    method: 'POST',
                    body: JSON.stringify({
                        templateOptions: {
                            title: `‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏° #${requestId}`,
                            showLogo: true
                        }
                    })
                });

                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `‡∏Ñ‡∏≥‡∏£‡πâ‡∏≠‡∏á‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°_${requestId}.pdf`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                    showToast('‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î PDF ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! üìÑ', 'success');
                } else {
                    const errorData = await response.json();
                    throw new Error(errorData.message || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡∏£‡πâ‡∏≤‡∏á PDF ‡πÑ‡∏î‡πâ');
                }
            } catch (error) {
                console.error('Error generating PDF:', error);
                showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        function openLookerReports() {
            if (lookerStudioUrl && lookerStudioUrl !== '#') {
                window.open(lookerStudioUrl, '_blank');
                showToast('‡πÄ‡∏õ‡∏¥‡∏î Looker Studio Dashboard', 'success');
            } else {
                showToast('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Looker Studio URL', 'error');
            }
        }

        function openLookerStudio() {
            openLookerReports();
        }

        function generateReport(period) {
            showToast(`‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô${period === 'today' ? '‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ' : period === 'week' ? '‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏ô‡∏µ‡πâ' : period === 'month' ? '‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ' : '‡∏õ‡∏µ‡∏ô‡∏µ‡πâ'}...`, 'info');
            
            if (lookerStudioUrl && lookerStudioUrl !== '#') {
                // Add period filter to Looker URL
                const separator = lookerStudioUrl.includes('?') ? '&' : '?';
                const reportUrl = `${lookerStudioUrl}${separator}period=${period}`;
                window.open(reportUrl, '_blank');
                showToast('‡πÄ‡∏õ‡∏¥‡∏î‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÉ‡∏ô Looker Studio', 'success');
            } else {
                showToast('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Looker Studio URL', 'error');
            }
        }

        // Export Functions
        function exportRequests() {
            showToast('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Export...', 'info');
            
            // Simple CSV export
            const headers = ['‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏Ñ‡∏≥‡∏Ç‡∏≠', '‡∏ú‡∏π‡πâ‡πÅ‡∏à‡πâ‡∏á', '‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£', '‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏™‡∏≤', '‡∏õ‡∏±‡∏ç‡∏´‡∏≤', '‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞', '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏à‡πâ‡∏á'];
            const csvContent = [
                headers.join(','),
                ...currentRequestsData.map(r => [
                    r.REQUEST_ID,
                    `"${r.FIRST_NAME || ''} ${r.LAST_NAME || ''}"`,
                    r.PHONE || '',
                    r.POLE_ID || '',
                    `"${(r.PROBLEM_DESCRIPTION || r.REASON || '').replace(/"/g, '""')}"`,
                    r.STATUS || '',
                    formatThaiDate(r.DATE_REPORTED)
                ].join(','))
            ].join('\n');

            const blob = new Blob(['\uFEFF' + csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `repair_requests_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
            
            showToast('Export ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! üìÅ', 'success');
        }

        async function exportRequestsPDF() {
            try {
                showLoading(true);
                showToast('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô PDF...', 'info');

                const response = await safeApiCall('/api/admin/reports/repair-requests/pdf', {
                    method: 'POST',
                    body: JSON.stringify({
                        filterStatus: document.getElementById('filterStatus').value,
                        dateRange: {
                            start: document.getElementById('filterDateFrom').value,
                            end: document.getElementById('filterDateTo').value
                        },
                        templateOptions: {
                            title: '‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°‡πÑ‡∏ü‡∏ü‡πâ‡∏≤',
                            showDate: true
                        }
                    })
                });

                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°_${new Date().toISOString().split('T')[0]}.pdf`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                    showToast('‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô PDF ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! üìÑ', 'success');
                } else {
                    const errorData = await response.json();
                    throw new Error(errorData.message || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô PDF ‡πÑ‡∏î‡πâ');
                }
            } catch (error) {
                console.error('Error generating PDF report:', error);
                showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        function exportInventory() {
            showToast('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏•‡∏±‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Export...', 'info');
            
            const headers = ['‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£', '‡∏´‡∏ô‡πà‡∏ß‡∏¢', '‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡πà‡∏≠‡∏´‡∏ô‡πà‡∏ß‡∏¢', '‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠', '‡πÄ‡∏ö‡∏¥‡∏Å‡πÅ‡∏•‡πâ‡∏ß', '‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏£‡∏ß‡∏°'];
            const csvContent = [
                headers.join(','),
                ...allInventory.map(item => [
                    `"${item.ITEM_NAME}"`,
                    item.UNIT || '',
                    item.PRICE_PER_UNIT || 0,
                    item.CURRENT_STOCK || 0,
                    item.USED_QUANTITY || 0,
                    (item.CURRENT_STOCK || 0) * (item.PRICE_PER_UNIT || 0)
                ].join(','))
            ].join('\n');

            const blob = new Blob(['\uFEFF' + csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `inventory_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
            
            showToast('Export ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏•‡∏±‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! üìÅ', 'success');
        }

        // Modal Functions
        function showAddInventoryModal() {
            const modal = new bootstrap.Modal(document.getElementById('addInventoryModal'));
            modal.show();
        }

        function showAddUserModal() {
            const modal = new bootstrap.Modal(document.getElementById('addUserModal'));
            modal.show();
        }

        async function saveNewInventoryItem() {
            try {
                const itemData = {
                    itemName: document.getElementById('newItemName').value,
                    unit: document.getElementById('newItemUnit').value,
                    pricePerUnit: parseFloat(document.getElementById('newItemPrice').value),
                    currentStock: parseInt(document.getElementById('newItemStock').value)
                };

                if (!itemData.itemName || !itemData.unit || isNaN(itemData.pricePerUnit) || isNaN(itemData.currentStock)) {
                    showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô', 'error');
                    return;
                }

                showLoading(true);
                const response = await safeApiCall('/api/admin/inventory', {
                    method: 'POST',
                    body: JSON.stringify(itemData)
                });

                const result = await response.json();
                if (result.status === 'success') {
                    showToast('‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! üì¶', 'success');
                    bootstrap.Modal.getInstance(document.getElementById('addInventoryModal')).hide();
                    document.getElementById('addInventoryForm').reset();
                    // Reload inventory data
                    allInventory = [];
                    await loadInventoryPage();
                } else {
                    throw new Error(result.message);
                }
            } catch (error) {
                console.error('Error adding inventory item:', error);
                showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        async function saveNewUser() {
            try {
                const userData = {
                    username: document.getElementById('newUsername').value,
                    password: document.getElementById('newPassword').value,
                    role: document.getElementById('newRole').value,
                    fullName: document.getElementById('newFullName').value,
                    email: document.getElementById('newEmail').value,
                    isActive: document.getElementById('newIsActive').checked
                };

                if (!userData.username || !userData.password || !userData.role) {
                    showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô', 'error');
                    return;
                }

                showLoading(true);
                const response = await safeApiCall('/api/admin/users', {
                    method: 'POST',
                    body: JSON.stringify(userData)
                });

                const result = await response.json();
                if (result.status === 'success') {
                    showToast('‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÉ‡∏´‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! üë§', 'success');
                    bootstrap.Modal.getInstance(document.getElementById('addUserModal')).hide();
                    document.getElementById('addUserForm').reset();
                    // Reload users data
                    allUsers = [];
                    await loadUsersPage();
                } else {
                    throw new Error(result.message);
                }
            } catch (error) {
                console.error('Error adding user:', error);
                showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        function editInventoryItem(itemName) {
            const item = allInventory.find(i => i.ITEM_NAME === itemName);
            if (!item) return;

            document.getElementById('editOriginalItemName').value = itemName;
            document.getElementById('editItemName').value = item.ITEM_NAME;
            document.getElementById('editItemUnit').value = item.UNIT || '';
            document.getElementById('editItemPrice').value = item.PRICE_PER_UNIT || 0;

            const modal = new bootstrap.Modal(document.getElementById('editInventoryModal'));
            modal.show();
        }

        async function saveEditInventoryItem() {
            try {
                const originalName = document.getElementById('editOriginalItemName').value;
                const itemData = {
                    itemName: document.getElementById('editItemName').value,
                    unit: document.getElementById('editItemUnit').value,
                    pricePerUnit: parseFloat(document.getElementById('editItemPrice').value)
                };

                if (!itemData.itemName || !itemData.unit || isNaN(itemData.pricePerUnit)) {
                    showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô', 'error');
                    return;
                }

                showLoading(true);
                const response = await safeApiCall(`/api/admin/inventory/${encodeURIComponent(originalName)}`, {
                    method: 'PUT',
                    body: JSON.stringify(itemData)
                });

                const result = await response.json();
                if (result.status === 'success') {
                    showToast('‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‚úèÔ∏è', 'success');
                    bootstrap.Modal.getInstance(document.getElementById('editInventoryModal')).hide();
                    // Reload inventory data
                    allInventory = [];
                    await loadInventoryPage();
                } else {
                    throw new Error(result.message);
                }
            } catch (error) {
                console.error('Error editing inventory item:', error);
                showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        function adjustInventory(itemName, action) {
            const actionText = action === 'add' ? '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏ï‡πá‡∏≠‡∏Å' : '‡πÄ‡∏ö‡∏¥‡∏Å‡∏™‡∏ï‡πá‡∏≠‡∏Å';
            const actionType = action === 'add' ? '‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤' : '‡πÄ‡∏ö‡∏¥‡∏Å‡∏à‡πà‡∏≤‡∏¢';
            
            document.getElementById('adjustItemName').value = itemName;
            document.getElementById('adjustItemNameDisplay').value = itemName;
            document.getElementById('adjustType').value = actionType;
            document.getElementById('adjustModalTitle').textContent = `üìä ${actionText}`;
            document.getElementById('adjustQuantity').value = '';
            document.getElementById('adjustNotes').value = '';

            const modal = new bootstrap.Modal(document.getElementById('adjustInventoryModal'));
            modal.show();
        }

        async function saveAdjustInventory() {
            try {
                const adjustData = {
                    itemName: document.getElementById('adjustItemName').value,
                    quantityChange: parseFloat(document.getElementById('adjustQuantity').value),
                    transactionType: document.getElementById('adjustType').value
                };

                if (!adjustData.itemName || isNaN(adjustData.quantityChange) || adjustData.quantityChange <= 0) {
                    showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', 'error');
                    return;
                }

                showLoading(true);
                const response = await safeApiCall('/api/admin/inventory/adjust', {
                    method: 'POST',
                    body: JSON.stringify(adjustData)
                });

                const result = await response.json();
                if (result.status === 'success') {
                    showToast('‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! üìä', 'success');
                    bootstrap.Modal.getInstance(document.getElementById('adjustInventoryModal')).hide();
                    // Reload inventory data
                    allInventory = [];
                    await loadInventoryPage();
                } else {
                    throw new Error(result.message);
                }
            } catch (error) {
                console.error('Error adjusting inventory:', error);
                showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        function deleteInventoryItem(itemName) {
            showConfirm(`‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ "${itemName}" ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`, async () => {
                try {
                    showLoading(true);
                    // Note: API endpoint for delete not implemented yet
                    showToast(`‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£: ${itemName} (‡∏ü‡∏µ‡πÄ‡∏à‡∏≠‡∏£‡πå‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°)`, 'info');
                } catch (error) {
                    showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message, 'error');
                } finally {
                    showLoading(false);
                }
            });
        }

        function editUser(username) {
            showToast(`‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ: ${username} (‡∏ü‡∏µ‡πÄ‡∏à‡∏≠‡∏£‡πå‡∏û‡∏±‡∏í‡∏ô‡∏≤‡πÉ‡∏ô‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô‡∏ñ‡∏±‡∏î‡πÑ‡∏õ)`, 'info');
        }

        function deleteUser(username) {
            showConfirm(`‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ "${username}" ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`, async () => {
                try {
                    showLoading(true);
                    const response = await safeApiCall(`/api/admin/users/${encodeURIComponent(username)}`, {
                        method: 'DELETE'
                    });

                    const result = await response.json();
                    if (result.status === 'success') {
                        showToast('‡∏•‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! üóëÔ∏è', 'success');
                        // Reload users data
                        allUsers = [];
                        await loadUsersPage();
                    } else {
                        throw new Error(result.message);
                    }
                } catch (error) {
                    showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message, 'error');
                } finally {
                    showLoading(false);
                }
            });
        }

        function updateRequestStatus(requestId) {
            const request = allRequests.find(r => r.REQUEST_ID === requestId);
            if (!request) return;

            document.getElementById('updateRequestId').value = requestId;
            document.getElementById('updateRequestIdDisplay').value = requestId;
            document.getElementById('updateNewStatus').value = request.STATUS || '';
            document.getElementById('updateTechnicianNotes').value = request.TECHNICIAN_NOTES || '';

            const modal = new bootstrap.Modal(document.getElementById('updateStatusModal'));
            modal.show();
        }

        async function saveUpdateStatus() {
            try {
                const updateData = {
                    newStatus: document.getElementById('updateNewStatus').value,
                    technicianNotes: document.getElementById('updateTechnicianNotes').value
                };

                if (!updateData.newStatus) {
                    showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÉ‡∏´‡∏°‡πà', 'error');
                    return;
                }

                const requestId = document.getElementById('updateRequestId').value;
                
                showLoading(true);
                const response = await safeApiCall(`/api/admin/repair-request/${requestId}/status`, {
                    method: 'PUT',
                    body: JSON.stringify(updateData)
                });

                const result = await response.json();
                if (result.status === 'success') {
                    showToast('‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! üìä', 'success');
                    bootstrap.Modal.getInstance(document.getElementById('updateStatusModal')).hide();
                    // Reload requests data
                    allRequests = [];
                    await loadStats();
                    if (document.getElementById('requestsPage').classList.contains('d-none') === false) {
                        await loadRequestsPage();
                    } else {
                        await loadRecentRequests();
                    }
                } else {
                    throw new Error(result.message);
                }
            } catch (error) {
                console.error('Error updating status:', error);
                showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        // Telegram Functions
        async function sendTelegramReport() {
            try {
                showLoading(true);
                const response = await safeApiCall('/api/admin/notifications/send-report', {
                    method: 'POST',
                    body: JSON.stringify({
                        reportType: 'summary',
                        filters: {}
                    })
                });

                const result = await response.json();
                if (result.status === 'success') {
                    showToast('‡∏™‡πà‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÑ‡∏õ Telegram ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! üì±', 'success');
                } else {
                    throw new Error(result.message);
                }
            } catch (error) {
                console.error('Error sending Telegram report:', error);
                showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        // Settings Functions
        document.getElementById('telegramForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const botToken = document.getElementById('botToken').value.trim();
            const chatId = document.getElementById('chatId').value.trim();
            const isEnabled = document.getElementById('enableTelegram').checked;
            
            try {
                showLoading(true);
                const response = await safeApiCall('/api/admin/telegram-config', {
                    method: 'POST',
                    body: JSON.stringify({ botToken, chatId, isEnabled })
                });
                
                const data = await response.json();
                if (data.status === 'success') {
                    showToast('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Telegram ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! üì±', 'success');
                } else {
                    throw new Error(data.message || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î');
                }
            } catch (error) {
                showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        });

        async function testTelegram() {
            const botToken = document.getElementById('botToken').value.trim();
            const chatId = document.getElementById('chatId').value.trim();
            
            if (!botToken || !chatId) {
                showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å Bot Token ‡πÅ‡∏•‡∏∞ Chat ID', 'error');
                return;
            }
            
            try {
                showLoading(true);
                const response = await safeApiCall('/api/admin/telegram-test', {
                    method: 'POST',
                    body: JSON.stringify({ botToken, chatId })
                });
                
                const data = await response.json();
                if (data.status === 'success') {
                    showToast('‡∏ó‡∏î‡∏™‡∏≠‡∏ö Telegram ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‚úÖ', 'success');
                } else {
                    showToast('‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ' + data.message, 'error');
                }
            } catch (error) {
                showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö', 'error');
            } finally {
                showLoading(false);
            }
        }

        // Utility Functions
        async function refreshData() {
            showToast('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...', 'info');
            allRequests = [];
            allInventory = [];
            allUsers = [];
            await loadDashboardData();
        }

        function showUserMenu() {
            Swal.fire({
                title: 'üë§ ‡πÄ‡∏°‡∏ô‡∏π‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ',
                html: `
                    <div class="text-center">
                        <div class="user-avatar mb-3" style="width: 80px; height: 80px; font-size: 2rem; margin: 0 auto;">
                            ${currentUser.username.charAt(0).toUpperCase()}
                        </div>
                        <h4>${currentUser.username}</h4>
                        <p class="text-muted">${getRoleDisplayName(currentUser.role)}</p>
                    </div>
                `,
                showCancelButton: true,
                confirmButtonText: 'üö™ ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö',
                cancelButtonText: '‚ùå ‡∏õ‡∏¥‡∏î',
                confirmButtonColor: '#ef4444',
                cancelButtonColor: '#6b7280'
            }).then((result) => {
                if (result.isConfirmed) {
                    logout();
                }
            });
        }

        function logout() {
            showConfirm('‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?', () => {
                if (window.AuthUtils && typeof window.AuthUtils.logout === 'function') {
                    window.AuthUtils.logout();
                } else {
                    window.location.href = '/admin/smart-login.html';
                }
            });
        }

        // Toast Notifications
        function showToast(message, type = 'info') {
            const iconMap = {
                success: 'success',
                error: 'error',
                warning: 'warning',
                info: 'info'
            };

            Swal.fire({
                icon: iconMap[type],
                title: message,
                toast: true,
                position: 'top-end',
                showConfirmButton: false,
                timer: 4000,
                timerProgressBar: true,
                background: 'linear-gradient(135deg, rgba(30, 41, 59, 0.95), rgba(51, 65, 85, 0.95))',
                color: '#f8fafc'
            });
        }

        function showConfirm(message, onConfirm) {
            Swal.fire({
                title: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£',
                text: message,
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: '‚úÖ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô',
                cancelButtonText: '‚ùå ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å',
                confirmButtonColor: '#10b981',
                cancelButtonColor: '#ef4444',
                background: 'linear-gradient(135deg, rgba(30, 41, 59, 0.95), rgba(51, 65, 85, 0.95))',
                color: '#f8fafc'
            }).then((result) => {
                if (result.isConfirmed && onConfirm) {
                    onConfirm();
                }
            });
        }

        // Responsive handling
        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('show');
        }

        // Auto refresh data when page becomes visible
        document.addEventListener('visibilitychange', function() {
            if (!document.hidden && currentUser) {
                refreshData();
            }
        });

        // Initialize tooltips and other Bootstrap components
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize Bootstrap tooltips if any
            var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
            var tooltipList = tooltipTriggerList.map(function(tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl);
            });

            // Initialize modals
            var modalElements = document.querySelectorAll('.modal');
            modalElements.forEach(function(modalEl) {
                new bootstrap.Modal(modalEl);
            });
        });

        // Additional utility functions for better UX
        function formatNumber(num) {
            return new Intl.NumberFormat('th-TH').format(num);
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('th-TH', {
                style: 'currency',
                currency: 'THB'
            }).format(amount);
        }

        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Search functionality with debounce
        const debouncedSearch = debounce(filterRequests, 500);
        
        // Add search event listeners
        document.addEventListener('DOMContentLoaded', function() {
            const searchInput = document.getElementById('searchRequestId');
            if (searchInput) {
                searchInput.addEventListener('input', debouncedSearch);
            }
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            // Ctrl/Cmd + K for search
            if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
                e.preventDefault();
                const searchInput = document.getElementById('searchRequestId');
                if (searchInput) {
                    searchInput.focus();
                }
            }
            
            // Escape to close modals
            if (e.key === 'Escape') {
                const openModals = document.querySelectorAll('.modal.show');
                openModals.forEach(modal => {
                    const modalInstance = bootstrap.Modal.getInstance(modal);
                    if (modalInstance) {
                        modalInstance.hide();
                    }
                });
            }
        });

        // Print functionality
        function printPage() {
            window.print();
        }

        // Error handling for API calls
        window.addEventListener('unhandledrejection', function(event) {
            console.error('Unhandled promise rejection:', event.reason);
            if (event.reason && event.reason.message) {
                showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + event.reason.message, 'error');
            } else {
                showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏Ñ‡∏≤‡∏î‡∏Ñ‡∏¥‡∏î', 'error');
            }
        });

        // Service Worker registration (for future offline support)
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                // Uncomment when service worker is ready
                // navigator.serviceWorker.register('/sw.js')
                //     .then(function(registration) {
                //         console.log('SW registered: ', registration);
                //     })
                //     .catch(function(registrationError) {
                //         console.log('SW registration failed: ', registrationError);
                //     });
            });
        }

        // Performance monitoring
        function logPerformance(label, startTime) {
            const endTime = performance.now();
            const duration = endTime - startTime;
            console.log(`${label}: ${duration.toFixed(2)}ms`);
        }

        // Cache management for better performance
        const cache = {
            data: new Map(),
            set: function(key, value, ttl = 300000) { // 5 minutes default TTL
                const item = {
                    value: value,
                    expiry: Date.now() + ttl
                };
                this.data.set(key, item);
            },
            get: function(key) {
                const item = this.data.get(key);
                if (!item) return null;
                if (Date.now() > item.expiry) {
                    this.data.delete(key);
                    return null;
                }
                return item.value;
            },
            clear: function() {
                this.data.clear();
            }
        };

        // Enhanced error reporting
        function reportError(error, context = '') {
            const errorReport = {
                message: error.message,
                stack: error.stack,
                context: context,
                userAgent: navigator.userAgent,
                timestamp: new Date().toISOString(),
                user: currentUser ? currentUser.username : 'anonymous'
            };
            
            console.error('Error Report:', errorReport);
            
            // Here you could send to an error tracking service
            // sendToErrorTrackingService(errorReport);
        }

        // Network status monitoring
        window.addEventListener('online', function() {
            showToast('‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏≠‡∏¥‡∏ô‡πÄ‡∏ó‡∏≠‡∏£‡πå‡πÄ‡∏ô‡πá‡∏ï‡πÅ‡∏•‡πâ‡∏ß', 'success');
            refreshData();
        });

        window.addEventListener('offline', function() {
            showToast('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏≠‡∏¥‡∏ô‡πÄ‡∏ó‡∏≠‡∏£‡πå‡πÄ‡∏ô‡πá‡∏ï', 'warning');
        });

        // Data validation helpers
        function validateRequestData(data) {
            const required = ['REQUEST_ID', 'STATUS'];
            const missing = required.filter(field => !data[field]);
            return {
                isValid: missing.length === 0,
                missingFields: missing
            };
        }

        function validateInventoryData(data) {
            const required = ['ITEM_NAME', 'UNIT', 'PRICE_PER_UNIT'];
            const missing = required.filter(field => !data[field]);
            return {
                isValid: missing.length === 0,
                missingFields: missing
            };
        }

        // Export helper functions
        function generateCSV(data, headers) {
            const csvContent = [
                headers.join(','),
                ...data.map(row => 
                    headers.map(header => {
                        const value = row[header] || '';
                        // Escape quotes and wrap in quotes if contains comma or quote
                        if (typeof value === 'string' && (value.includes(',') || value.includes('"'))) {
                            return `"${value.replace(/"/g, '""')}"`;
                        }
                        return value;
                    }).join(',')
                )
            ].join('\n');
            
            return '\uFEFF' + csvContent; // Add BOM for Excel compatibility
        }

        function downloadFile(content, filename, mimeType = 'text/plain') {
            const blob = new Blob([content], { type: mimeType });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
        }

        // Initialize app when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeApp);
        } else {
            initializeApp();
        }

        // Global error handler
        window.onerror = function(msg, url, lineNo, columnNo, error) {
            reportError(error || new Error(msg), `${url}:${lineNo}:${columnNo}`);
            return false;
        };

        // Cleanup on page unload
        window.addEventListener('beforeunload', function() {
            // Cleanup any ongoing operations
            if (statusChart) statusChart.destroy();
            if (trendChart) trendChart.destroy();
            cache.clear();
        });

        // Custom form validation
        function validateForm(formId) {
            const form = document.getElementById(formId);
            if (!form) return false;
            
            const inputs = form.querySelectorAll('input[required], select[required], textarea[required]');
            let isValid = true;
            
            inputs.forEach(input => {
                if (!input.value.trim()) {
                    input.classList.add('is-invalid');
                    isValid = false;
                } else {
                    input.classList.remove('is-invalid');
                }
            });
            
            return isValid;
        }

        // Auto-save functionality for forms
        function setupAutoSave(formId, storageKey) {
            const form = document.getElementById(formId);
            if (!form) return;
            
            // Load saved data
            const savedData = localStorage.getItem(storageKey);
            if (savedData) {
                try {
                    const data = JSON.parse(savedData);
                    Object.keys(data).forEach(key => {
                        const input = form.querySelector(`[name="${key}"], #${key}`);
                        if (input) {
                            input.value = data[key];
                        }
                    });
                } catch (e) {
                    console.warn('Failed to load saved form data:', e);
                }
            }
            
            // Save on input
            form.addEventListener('input', debounce(() => {
                const formData = new FormData(form);
                const data = Object.fromEntries(formData.entries());
                localStorage.setItem(storageKey, JSON.stringify(data));
            }, 1000));
            
            // Clear on submit
            form.addEventListener('submit', () => {
                localStorage.removeItem(storageKey);
            });
        }

        // Theme management (if needed in future)
        function toggleTheme() {
            const currentTheme = document.documentElement.getAttribute('data-theme');
            const newTheme = currentTheme === 'light' ? 'dark' : 'light';
            document.documentElement.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
        }

        // Initialize theme
        const savedTheme = localStorage.getItem('theme') || 'dark';
        document.documentElement.setAttribute('data-theme', savedTheme);

        console.log('üöÄ Dashboard initialized successfully!');
    </script>
</body>
</html>
