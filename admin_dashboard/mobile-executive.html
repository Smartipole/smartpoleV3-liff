<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‚ö° ‡∏£‡∏∞‡∏ö‡∏ö‡∏ú‡∏π‡πâ‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£ - ‡∏≠‡∏ö‡∏ï.‡∏Ç‡πà‡∏≤‡πÉ‡∏´‡∏ç‡πà</title>
    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#1e3a8a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="SP Executive">
    <meta name="msapplication-TileColor" content="#1e3a8a">
    <meta name="msapplication-tap-highlight" content="no">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="/executive-manifest.json">
    
    <!-- Apple Touch Icons -->
    <link rel="apple-touch-icon" href="/icons/executive-icon-192.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/icons/executive-icon-192.png">
    
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzIiIGhlaWdodD0iMzIiIHZpZXdCb3g9IjAgMCAzMiAzMiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjMyIiBoZWlnaHQ9IjMyIiByeD0iNCIgZmlsbD0iI2ZiYmYyNCIvPgo8dGV4dCB4PSIxNiIgeT0iMTkiIGZvbnQtZmFtaWx5PSJBcmlhbCwgc2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgZmlsbD0iIzBmMTcyYSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZG9taW5hbnQtYmFzZWxpbmU9ImNlbnRyYWwiPuKaoTwvdGV4dD4KPC9zdmc+Cg==">
    
    <!-- SweetAlert2 CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/limonte-sweetalert2/11.10.1/sweetalert2.min.css">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 25%, #334155 50%, #475569 75%, #64748b 100%);
            color: #f8fafc;
            min-height: 100vh;
            overflow-x: hidden;
        }

        .container {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 50%, #d97706 100%);
            padding: 1rem 2rem;
            box-shadow: 0 8px 32px rgba(251, 191, 36, 0.3);
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            z-index: 100;
            backdrop-filter: blur(10px);
        }

        .header-brand {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .header-icon {
            font-size: 2.5rem;
            color: #0f172a;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
            animation: pulse-glow 2s infinite;
        }

        @keyframes pulse-glow {
            0%, 100% { transform: scale(1); filter: brightness(1); }
            50% { transform: scale(1.1); filter: brightness(1.2); }
        }

        .header-title {
            color: #0f172a;
            font-size: 1.5rem;
            font-weight: 800;
            text-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .header-subtitle {
            color: #64748b;
            font-size: 0.9rem;
            margin-top: 0.25rem;
        }

        .header-user {
            display: flex;
            align-items: center;
            gap: 1rem;
            cursor: pointer;
            padding: 0.5rem 1rem;
            border-radius: 50px;
            background: rgba(15, 23, 42, 0.2);
            transition: all 0.3s ease;
            position: relative;
        }

        .header-user:hover {
            background: rgba(15, 23, 42, 0.4);
            transform: translateY(-2px);
        }

        /* Notification Badge */
        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #ef4444;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: none;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            font-weight: bold;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        .user-avatar {
            width: 3rem;
            height: 3rem;
            border-radius: 50%;
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 1.2rem;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
        }

        .user-info {
            display: flex;
            flex-direction: column;
        }

        .user-name {
            color: #0f172a;
            font-weight: 600;
            font-size: 0.95rem;
        }

        .user-role {
            color: #64748b;
            font-size: 0.8rem;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            padding: 2rem;
            padding-bottom: 6rem;
        }

        /* Cards */
        .card {
            background: linear-gradient(135deg, rgba(30, 41, 59, 0.9), rgba(51, 65, 85, 0.7));
            border-radius: 1rem;
            padding: 2rem;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(251, 191, 36, 0.2);
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
            margin-bottom: 1.5rem;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 40px rgba(251, 191, 36, 0.2);
            border-color: rgba(251, 191, 36, 0.4);
        }

        .card::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, transparent, rgba(251, 191, 36, 0.1), transparent);
            transform: rotate(45deg);
            transition: all 0.6s ease;
        }

        .card:hover::before {
            animation: shine 0.6s ease-in-out;
        }

        @keyframes shine {
            0% { transform: translateX(-100%) translateY(-100%) rotate(45deg); }
            100% { transform: translateX(100%) translateY(100%) rotate(45deg); }
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1.5rem;
            margin-bottom: 3rem;
        }

        .stat-card {
            background: linear-gradient(135deg, rgba(30, 41, 59, 0.9), rgba(51, 65, 85, 0.7));
            border-radius: 1rem;
            padding: 1.5rem;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(251, 191, 36, 0.2);
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 40px rgba(251, 191, 36, 0.2);
            border-color: rgba(251, 191, 36, 0.4);
        }

        .stat-content h3 {
            font-size: 0.9rem;
            color: #cbd5e1;
            margin-bottom: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 500;
        }

        .stat-content p {
            font-size: 2rem;
            font-weight: 800;
            color: #fbbf24;
            line-height: 1;
        }

        .stat-icon {
            font-size: 2.5rem;
            opacity: 0.8;
        }

        /* Performance Card */
        .performance-card {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.15), rgba(5, 150, 105, 0.1));
            border: 1px solid rgba(16, 185, 129, 0.3);
        }

        .performance-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
            margin-top: 1rem;
        }

        .performance-item {
            background: rgba(15, 23, 42, 0.3);
            padding: 1rem;
            border-radius: 0.5rem;
            text-align: center;
        }

        .performance-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: #10b981;
        }

        .performance-label {
            font-size: 0.8rem;
            color: #cbd5e1;
            margin-top: 0.25rem;
        }

        /* Alert Cards */
        .alert-card {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.15), rgba(220, 38, 38, 0.1));
            border: 1px solid rgba(239, 68, 68, 0.3);
            padding: 1rem;
            border-radius: 0.75rem;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .alert-card:hover {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.2), rgba(220, 38, 38, 0.15));
            transform: translateY(-2px);
        }

        .alert-icon {
            font-size: 1.5rem;
            color: #ef4444;
        }

        .alert-content {
            flex: 1;
        }

        .alert-title {
            font-weight: 600;
            color: #f8fafc;
            margin-bottom: 0.25rem;
        }

        .alert-description {
            font-size: 0.9rem;
            color: #e2e8f0;
        }

        /* Chart Container */
        .chart-container {
            background: rgba(15, 23, 42, 0.3);
            border-radius: 0.75rem;
            padding: 1.5rem;
            margin-top: 1rem;
            text-align: center;
            min-height: 200px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .chart-placeholder {
            color: #94a3b8;
            font-style: italic;
            font-size: 1rem;
        }

        .real-chart {
            width: 100%;
            height: 200px;
        }

        /* Section Titles */
        .section-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: #fbbf24;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .section-icon {
            font-size: 1.8rem;
            color: #f59e0b;
        }

        /* Quick Action Cards */
        .quick-actions-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .quick-action-card {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.2), rgba(5, 150, 105, 0.1));
            border: 1px solid rgba(16, 185, 129, 0.3);
            color: #f8fafc;
            border-radius: 1rem;
            padding: 1.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            position: relative;
            overflow: hidden;
            text-align: center;
        }

        .quick-action-card:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: 0 20px 40px rgba(16, 185, 129, 0.3);
            border-color: rgba(16, 185, 129, 0.6);
        }

        .quick-action-icon {
            font-size: 2rem;
            color: #10b981;
            margin-bottom: 0.5rem;
        }

        .quick-action-title {
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: #f8fafc;
            font-size: 0.9rem;
        }

        .quick-action-value {
            font-size: 1.2rem;
            font-weight: bold;
            color: #10b981;
        }

        /* Village Analysis */
        .village-item {
            background: rgba(15, 23, 42, 0.3);
            padding: 1rem;
            border-radius: 0.5rem;
            margin-bottom: 0.75rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .village-item:hover {
            background: rgba(15, 23, 42, 0.5);
            transform: translateY(-2px);
        }

        .village-name {
            font-weight: 500;
            color: #f8fafc;
        }

        .village-stats {
            font-size: 0.8rem;
            color: #cbd5e1;
            margin-top: 0.25rem;
        }

        .village-count {
            background: rgba(251, 191, 36, 0.2);
            color: #fbbf24;
            padding: 0.25rem 0.75rem;
            border-radius: 50px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        /* Progress Bars */
        .progress-container {
            margin-top: 1rem;
        }

        .progress-item {
            margin-bottom: 1rem;
        }

        .progress-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
            color: #e2e8f0;
        }

        .progress-bar {
            height: 8px;
            background: rgba(15, 23, 42, 0.5);
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #10b981, #059669);
            border-radius: 4px;
            transition: width 0.3s ease;
        }

        /* Status badges */
        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 50px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .status-badge.status-pending {
            background: rgba(251, 191, 36, 0.2);
            color: #fbbf24;
            border: 1px solid rgba(251, 191, 36, 0.3);
        }

        .status-badge.status-approved {
            background: rgba(16, 185, 129, 0.2);
            color: #10b981;
            border: 1px solid rgba(16, 185, 129, 0.3);
        }

        .status-badge.status-rejected {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
            border: 1px solid rgba(239, 68, 68, 0.3);
        }

        .status-badge.status-overdue {
            background: rgba(239, 68, 68, 0.3);
            color: #ef4444;
            border: 1px solid rgba(239, 68, 68, 0.5);
            animation: blink 1.5s infinite;
        }

        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0.7; }
        }

        /* Request Cards */
        .request-card {
            background: linear-gradient(135deg, rgba(30, 41, 59, 0.9), rgba(51, 65, 85, 0.7));
            border-radius: 1rem;
            padding: 1.5rem;
            margin-bottom: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid rgba(251, 191, 36, 0.2);
            position: relative;
            overflow: hidden;
        }

        .request-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 40px rgba(251, 191, 36, 0.2);
            border-color: rgba(251, 191, 36, 0.4);
        }

        .request-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1rem;
        }

        .request-id {
            font-size: 0.9rem;
            font-weight: 600;
            color: #fbbf24;
        }

        .request-time {
            font-size: 0.8rem;
            color: #94a3b8;
        }

        .request-info {
            display: flex;
            align-items: center;
            margin-bottom: 0.75rem;
            font-size: 0.9rem;
            color: #e2e8f0;
        }

        .request-info-icon {
            width: 1.2rem;
            height: 1.2rem;
            margin-right: 0.75rem;
            color: #fbbf24;
        }

        .request-reason {
            font-size: 0.9rem;
            color: #e2e8f0;
            margin-top: 1rem;
            padding: 1rem;
            background: rgba(15, 23, 42, 0.3);
            border-radius: 0.5rem;
            border-left: 4px solid #fbbf24;
        }

        /* Signature Pad Styles */
        .signature-modal {
            background: linear-gradient(135deg, rgba(30, 41, 59, 0.98), rgba(51, 65, 85, 0.98)) !important;
            border: 1px solid rgba(251, 191, 36, 0.3) !important;
            border-radius: 1rem !important;
            color: #f8fafc !important;
            padding: 0 !important;
        }

        .signature-container {
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .signature-header {
            text-align: center;
            margin-bottom: 1rem;
        }

        .signature-title {
            color: #fbbf24;
            font-size: 1.2rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .signature-subtitle {
            color: #e2e8f0;
            font-size: 0.9rem;
        }

        .signature-canvas-container {
            background: #f8fafc;
            border: 2px solid rgba(251, 191, 36, 0.5);
            border-radius: 0.5rem;
            position: relative;
            margin: 1rem 0;
        }

        .signature-canvas {
            width: 100%;
            height: 200px;
            border-radius: 0.5rem;
            cursor: crosshair;
        }

        .signature-placeholder {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #94a3b8;
            font-size: 0.9rem;
            pointer-events: none;
            text-align: center;
        }

        .signature-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 1rem;
            gap: 0.5rem;
        }

        .signature-clear-btn {
            background: rgba(148, 163, 184, 0.3) !important;
            border: 1px solid rgba(148, 163, 184, 0.3) !important;
            border-radius: 0.5rem !important;
            color: #f8fafc !important;
            padding: 0.5rem 1rem !important;
            font-size: 0.85rem !important;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .signature-clear-btn:hover {
            background: rgba(148, 163, 184, 0.5) !important;
        }

        .signature-actions {
            display: flex;
            gap: 0.5rem;
        }

        .signature-cancel-btn {
            background: linear-gradient(135deg, #ef4444, #dc2626) !important;
            border: none !important;
            border-radius: 0.5rem !important;
            color: white !important;
            padding: 0.75rem 1rem !important;
            font-weight: 600 !important;
            cursor: pointer;
            font-size: 0.85rem !important;
        }

        .signature-submit-btn {
            background: linear-gradient(135deg, #10b981, #059669) !important;
            border: none !important;
            border-radius: 0.5rem !important;
            color: white !important;
            padding: 0.75rem 1rem !important;
            font-weight: 600 !important;
            cursor: pointer;
            font-size: 0.85rem !important;
        }

        .signature-submit-btn:disabled {
            background: rgba(148, 163, 184, 0.3) !important;
            cursor: not-allowed;
        }

        /* Animation for signature drawing */
        @keyframes signature-draw {
            from { opacity: 0.7; }
            to { opacity: 1; }
        }

        .signature-canvas.drawing {
            animation: signature-draw 0.1s ease-in-out;
        }

        /* Bottom Navigation */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(135deg, rgba(30, 41, 59, 0.95), rgba(51, 65, 85, 0.95));
            backdrop-filter: blur(20px);
            border-top: 1px solid rgba(251, 191, 36, 0.3);
            padding: 1rem 0.5rem;
            display: flex;
            justify-content: space-around;
            z-index: 90;
            box-shadow: 0 -8px 32px rgba(0, 0, 0, 0.3);
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 0.75rem 1rem;
            border-radius: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            color: #94a3b8;
            font-size: 0.8rem;
            text-align: center;
            min-width: 70px;
            position: relative;
        }

        .nav-item.active {
            color: #fbbf24;
            background: rgba(251, 191, 36, 0.1);
            border: 1px solid rgba(251, 191, 36, 0.3);
            transform: translateY(-2px);
        }

        .nav-item:hover:not(.active) {
            color: #f8fafc;
            background: rgba(248, 250, 252, 0.1);
            transform: translateY(-2px);
        }

        .nav-icon {
            font-size: 1.5rem;
            margin-bottom: 0.25rem;
        }

        /* Loading */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2rem;
            color: #e2e8f0;
            animation: pulse-loading 1.5s infinite;
        }

        @keyframes pulse-loading {
            0%, 100% { opacity: 0.6; }
            50% { opacity: 1; }
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 3rem 2rem;
            color: #e2e8f0;
        }

        .empty-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
            color: #94a3b8;
        }

        /* SweetAlert2 Custom Styling */
        .swal2-popup {
            background: linear-gradient(135deg, rgba(30, 41, 59, 0.95), rgba(51, 65, 85, 0.95)) !important;
            border: 1px solid rgba(251, 191, 36, 0.3) !important;
            border-radius: 1rem !important;
            color: #f8fafc !important;
        }

        .swal2-title {
            color: #fbbf24 !important;
            font-weight: 700 !important;
        }

        .swal2-content {
            color: #f8fafc !important;
        }

        .swal2-html-container {
            color: #e2e8f0 !important;
        }

        .swal2-confirm {
            background: linear-gradient(135deg, #10b981, #059669) !important;
            border: none !important;
            border-radius: 0.5rem !important;
            font-weight: 600 !important;
            padding: 0.75rem 1.5rem !important;
        }

        .swal2-cancel {
            background: linear-gradient(135deg, #ef4444, #dc2626) !important;
            border: none !important;
            border-radius: 0.5rem !important;
            font-weight: 600 !important;
            padding: 0.75rem 1.5rem !important;
        }

        .swal2-deny {
            background: rgba(148, 163, 184, 0.3) !important;
            border: 1px solid rgba(148, 163, 184, 0.3) !important;
            border-radius: 0.5rem !important;
            font-weight: 600 !important;
            padding: 0.75rem 1.5rem !important;
            color: #f8fafc !important;
        }

        .swal2-input {
            background: rgba(15, 23, 42, 0.5) !important;
            color: #f8fafc !important;
            border: 1px solid rgba(251, 191, 36, 0.3) !important;
        }

        .swal2-input:focus {
            border-color: #fbbf24 !important;
            box-shadow: 0 0 0 3px rgba(251, 191, 36, 0.2) !important;
        }

        .request-detail-popup {
            background: linear-gradient(135deg, rgba(30, 41, 59, 0.98), rgba(51, 65, 85, 0.98)) !important;
        }

        #statusFilter {
            background: rgba(15, 23, 42, 0.7) !important;
            color: #f8fafc !important;
            border: 1px solid rgba(251, 191, 36, 0.3) !important;
            border-radius: 0.5rem !important;
            padding: 0.5rem !important;
        }

        #statusFilter:focus {
            border-color: #fbbf24 !important;
            box-shadow: 0 0 0 2px rgba(251, 191, 36, 0.2) !important;
        }

        #statusFilter option {
            background: rgba(30, 41, 59, 0.95) !important;
            color: #f8fafc !important;
        }

        /* Utilities */
        .hidden {
            display: none !important;
        }

        .text-center {
            text-align: center;
        }

        .mb-2 {
            margin-bottom: 0.5rem;
        }

        .mb-4 {
            margin-bottom: 1rem;
        }

        .mt-4 {
            margin-top: 1rem;
        }

        .text-sm {
            font-size: 0.875rem;
        }

        .w-full {
            width: 100%;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .main-content {
                padding: 1rem;
                padding-bottom: 6rem;
            }
            
            .stats-grid {
                gap: 1rem;
            }
            
            .stat-card {
                padding: 1rem;
            }
            
            .header {
                padding: 1rem;
            }
            
            .header-title {
                font-size: 1.2rem;
            }
            
            .section-title {
                font-size: 1.3rem;
            }

            .quick-actions-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 480px) {
            .bottom-nav {
                padding: 0.75rem 0.25rem;
            }
            
            .nav-item {
                padding: 0.5rem 0.25rem;
                font-size: 0.7rem;
                min-width: 60px;
            }
            
            .nav-icon {
                font-size: 1.2rem;
            }
        }

        .back-btn {
            background: linear-gradient(135deg, #94a3b8, #64748b);
            color: white;
            border: none;
            border-radius: 0.5rem;
            padding: 0.75rem 1.5rem;
            font-weight: 600;
            cursor: pointer;
            margin-bottom: 1.5rem;
            transition: all 0.3s ease;
        }

        .back-btn:hover {
            background: linear-gradient(135deg, #64748b, #475569);
            transform: translateY(-2px);
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header class="header">
            <div class="header-brand">
                <div class="header-icon">‚ö°</div>
                <div>
                    <h1 class="header-title" id="pageTitle">‡∏£‡∏∞‡∏ö‡∏ö‡∏ú‡∏π‡πâ‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£</h1>
                    <p class="header-subtitle">‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ ‡∏Ñ‡∏∏‡∏ì<span id="userDisplay">Loading...</span> - ‡∏™‡πà‡∏≠‡∏á‡∏™‡∏ß‡πà‡∏≤‡∏á‡∏ó‡∏∏‡∏Å‡∏°‡∏∏‡∏°‡πÄ‡∏°‡∏∑‡∏≠‡∏á</p>
                </div>
            </div>
            <div class="header-user" onclick="showProfilePage()">
                <div class="notification-badge" id="notificationBadge">!</div>
                <div class="user-avatar" id="userAvatar">E</div>
                <div class="user-info">
                    <div class="user-name" id="userName">Loading...</div>
                    <div class="user-role" id="userRole">‡∏ú‡∏π‡πâ‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£</div>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Dashboard Page -->
            <div id="dashboardPage">
                <!-- Alert Section -->
                <section class="alerts-section" id="alertsSection" style="display: none;">
                    <h2 class="section-title">
                        <span class="section-icon">üö®</span>
                        ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç
                    </h2>
                    <div id="alertsList"></div>
                </section>

                <!-- Stats Section -->
                <section class="stats-section">
                    <h2 class="section-title">
                        <span class="section-icon">üìä</span>
                        ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°
                    </h2>
                    <div class="stats-grid">
                        <div class="stat-card" onclick="showAllRequests()">
                            <div class="stat-content">
                                <h3>‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h3>
                                <p id="totalCount">-</p>
                            </div>
                            <div class="stat-icon">üìã</div>
                        </div>
                        
                        <div class="stat-card" onclick="showPendingRequests()">
                            <div class="stat-content">
                                <h3>‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</h3>
                                <p id="pendingCount" style="color: #fbbf24;">-</p>
                            </div>
                            <div class="stat-icon">‚è∞</div>
                        </div>
                        
                        <div class="stat-card" onclick="showApprovedRequests()">
                            <div class="stat-content">
                                <h3>‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß</h3>
                                <p id="approvedCount" style="color: #10b981;">-</p>
                            </div>
                            <div class="stat-icon">‚úÖ</div>
                        </div>
                        
                        <div class="stat-card" onclick="showRejectedRequests()">
                            <div class="stat-content">
                                <h3>‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò</h3>
                                <p id="rejectedCount" style="color: #ef4444;">-</p>
                            </div>
                            <div class="stat-icon">‚ùå</div>
                        </div>
                    </div>
                </section>

                <!-- Performance Section -->
                <section class="performance-section">
                    <h2 class="section-title">
                        <span class="section-icon">üìà</span>
                        ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏á‡∏≤‡∏ô
                    </h2>
                    <div class="card performance-card">
                        <h3 style="color: #10b981; margin-bottom: 1rem;">KPI ‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</h3>
                        <div class="performance-grid">
                            <div class="performance-item">
                                <div class="performance-value" id="avgApprovalTime">-</div>
                                <div class="performance-label">‡πÄ‡∏ß‡∏•‡∏≤‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢ (‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á)</div>
                            </div>
                            <div class="performance-item">
                                <div class="performance-value" id="approvalRate">-</div>
                                <div class="performance-label">‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ (%)</div>
                            </div>
                            <div class="performance-item">
                                <div class="performance-value" id="responseTime">-</div>
                                <div class="performance-label">‡∏ï‡∏≠‡∏ö‡∏™‡∏ô‡∏≠‡∏á‡∏†‡∏≤‡∏¢‡πÉ‡∏ô 24 ‡∏ä‡∏°. (%)</div>
                            </div>
                            <div class="performance-item">
                                <div class="performance-value" id="monthlyTarget">85%</div>
                                <div class="performance-label">‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</div>
                            </div>
                        </div>
                        
                        <div class="progress-container">
                            <div class="progress-item">
                                <div class="progress-label">
                                    <span>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∑‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</span>
                                    <span id="targetProgress">0%</span>
                                </div>
                                <div class="progress-bar">
                                    <div class="progress-fill" id="targetProgressBar" style="width: 0%"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Quick Actions -->
                <section class="quick-actions-section">
                    <h2 class="section-title">
                        <span class="section-icon">‚ö°</span>
                        ‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏î‡πà‡∏ß‡∏ô
                    </h2>
                    
                    <div class="quick-actions-grid">
                        <div class="quick-action-card" onclick="showPendingRequests()">
                            <div class="quick-action-icon">üîî</div>
                            <div class="quick-action-title">‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</div>
                            <div class="quick-action-value" id="quickPendingCount">-</div>
                        </div>
                        
                        <div class="quick-action-card" onclick="showOverdueRequests()">
                            <div class="quick-action-icon">‚ö†Ô∏è</div>
                            <div class="quick-action-title">‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏Ñ‡πâ‡∏≤‡∏á‡∏ô‡∏≤‡∏ô</div>
                            <div class="quick-action-value" id="overdueCount">-</div>
                        </div>
                        
                        <div class="quick-action-card" onclick="showVillageAnalysis()">
                            <div class="quick-action-icon">üèòÔ∏è</div>
                            <div class="quick-action-title">‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏õ‡∏±‡∏ç‡∏´‡∏≤</div>
                            <div class="quick-action-value" id="villageCount">-</div>
                        </div>
                        
                        <div class="quick-action-card" onclick="generateReport()">
                            <div class="quick-action-icon">üìÑ</div>
                            <div class="quick-action-title">‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</div>
                            <div class="quick-action-value">PDF</div>
                        </div>
                    </div>
                </section>

                <!-- Chart Section -->
                <section class="chart-section">
                    <h2 class="section-title">
                        <span class="section-icon">üìä</span>
                        ‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°
                    </h2>
                    <div class="card">
                        <h3 style="color: #fbbf24; margin-bottom: 1rem;">‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏£‡∏≤‡∏¢‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå</h3>
                        <div class="chart-container" id="monthlyChart">
                            <canvas class="real-chart" id="trendChart"></canvas>
                        </div>
                    </div>
                </section>

                <!-- Recent Requests -->
                <section class="recent-requests-section">
                    <h2 class="section-title">
                        <span class="section-icon">‚è∞</span>
                        ‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
                    </h2>
                    <div id="recentRequests">
                        <div class="loading">
                            <span style="font-size: 2rem; margin-right: 1rem;">‚ö°</span>
                            ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...
                        </div>
                    </div>
                </section>
            </div>

            <!-- Village Analysis Page -->
            <div id="villageAnalysisPage" class="hidden">
                <button class="back-btn" onclick="showDashboard()">‚Üê ‡∏Å‡∏•‡∏±‡∏ö‡∏™‡∏π‡πà‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î</button>
                
                <section class="village-analysis-section">
                    <h2 class="section-title">
                        <span class="section-icon">üèòÔ∏è</span>
                        ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°‡∏ï‡∏≤‡∏°‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà
                    </h2>
                    <div class="card">
                        <h3 style="color: #fbbf24; margin-bottom: 1rem;">‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏ï‡∏≤‡∏°‡∏´‡∏°‡∏π‡πà‡∏ö‡πâ‡∏≤‡∏ô</h3>
                        <div id="villageStatsList">
                            <div class="loading">
                                <span style="font-size: 2rem; margin-right: 1rem;">üèòÔ∏è</span>
                                ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...
                            </div>
                        </div>
                    </div>
                    
                    <div class="card">
                        <h3 style="color: #fbbf24; margin-bottom: 1rem;">‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏à‡∏≤‡∏¢‡∏ï‡∏±‡∏ß‡∏Ç‡∏≠‡∏á‡∏õ‡∏±‡∏ç‡∏´‡∏≤</h3>
                        <div class="chart-container" id="villageChart">
                            <canvas class="real-chart" id="villageDistributionChart"></canvas>
                        </div>
                    </div>
                </section>
            </div>

            <!-- Requests Page -->
            <div id="requestsPage" class="hidden">
                <button class="back-btn" onclick="showDashboard()">‚Üê ‡∏Å‡∏•‡∏±‡∏ö‡∏™‡∏π‡πà‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î</button>
                
                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <h3 style="color: #fbbf24;">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏Ç‡∏≠</h3>
                        <select id="statusFilter" onchange="filterRequests()">
                            <option value="all">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
                            <option value="‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£">‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</option>
                            <option value="‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß‡∏£‡∏≠‡∏ä‡πà‡∏≤‡∏á">‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß</option>
                            <option value="‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÇ‡∏î‡∏¢‡∏ú‡∏π‡πâ‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£">‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò</option>
                        </select>
                    </div>
                    <div id="requestsList">
                        <div class="loading">
                            <span style="font-size: 2rem; margin-right: 1rem;">üìã</span>
                            ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...
                        </div>
                    </div>
                </div>
            </div>

            <!-- Profile Page -->
            <div id="profilePage" class="hidden">
                <button class="back-btn" onclick="showDashboard()">‚Üê ‡∏Å‡∏•‡∏±‡∏ö‡∏™‡∏π‡πà‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î</button>
                
                <div class="card">
                    <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 2rem;">
                        <div class="user-avatar" id="profilePageAvatar" style="width: 4rem; height: 4rem; font-size: 2rem;">E</div>
                        <div>
                            <h2 id="profilePageUsername" style="font-size: 1.25rem; font-weight: 600; color: #fbbf24;">Username</h2>
                            <p id="profilePageRole" style="color: #94a3b8;">Role</p>
                        </div>
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr; gap: 1rem;">
                        <div style="background: rgba(15, 23, 42, 0.3); padding: 1rem 1.25rem; border-radius: 0.5rem; border: 1px solid rgba(251, 191, 36, 0.2);">
                            <strong style="color: #fbbf24;">‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏ï‡πá‡∏°:</strong> <span id="profilePageFullName">-</span>
                        </div>
                        <div style="background: rgba(15, 23, 42, 0.3); padding: 1rem 1.25rem; border-radius: 0.5rem; border: 1px solid rgba(251, 191, 36, 0.2);">
                            <strong style="color: #fbbf24;">‡∏≠‡∏µ‡πÄ‡∏°‡∏•:</strong> <span id="profilePageEmail">-</span>
                        </div>
                        <div style="background: rgba(15, 23, 42, 0.3); padding: 1rem 1.25rem; border-radius: 0.5rem; border: 1px solid rgba(251, 191, 36, 0.2);">
                            <strong style="color: #fbbf24;">‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏ä‡πâ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î:</strong> <span id="profilePageLastLogin">-</span>
                        </div>
                        <div style="background: rgba(15, 23, 42, 0.3); padding: 1rem 1.25rem; border-radius: 0.5rem; border: 1px solid rgba(251, 191, 36, 0.2);">
                            <strong style="color: #fbbf24;">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞:</strong> <span id="profilePageStatus">-</span>
                        </div>
                    </div>

                    <div style="margin-top: 2rem; display: flex; flex-direction: column; gap: 1rem;">
                        <button style="background: linear-gradient(135deg, #ef4444, #dc2626); color: white; border: none; border-radius: 0.5rem; padding: 0.75rem 1.5rem; font-weight: 600; cursor: pointer; transition: all 0.3s ease;" onclick="handleLogout()">üö™ ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
                    </div>
                </div>
            </div>
        </main>

        <!-- Bottom Navigation -->
        <nav class="bottom-nav">
            <div class="nav-item active" onclick="showDashboard()">
                <div class="nav-icon">üè†</div>
                <div>‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</div>
            </div>
            <div class="nav-item" onclick="showRequestsPage()">
                <div class="nav-icon">üìã</div>
                <div>‡∏Ñ‡∏≥‡∏Ç‡∏≠</div>
            </div>
            <div class="nav-item" onclick="showVillageAnalysis()">
                <div class="nav-icon">üèòÔ∏è</div>
                <div>‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà</div>
            </div>
            <div class="nav-item" onclick="generateReport()">
                <div class="nav-icon">üìÑ</div>
                <div>‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</div>
            </div>
            <div class="nav-item" onclick="showProfilePage()">
                <div class="nav-icon">üë§</div>
                <div>‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå</div>
            </div>
        </nav>
    </div>

    <!-- Chart.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <!-- SweetAlert2 JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/limonte-sweetalert2/11.10.1/sweetalert2.min.js"></script>
    <script src="/auth-utils.js"></script>
    
    <script>
        // Global variables
        let currentUser = null;
        let allRequests = [];
        let allPoles = [];
        let allUsers = [];
        let currentFilters = { status: 'all', search: '' };
        let dashboardStats = {
            total: 0,
            pending: 0,
            approved: 0,
            rejected: 0,
            overdue: 0,
            thisMonth: 0,
            avgResponseTime: 0,
            approvalRate: 0
        };

        // Chart instances
        let trendChart = null;
        let villageChart = null;

        // Signature pad variables
        let signaturePad = null;
        let isDrawing = false;

        // Page identifiers
        const PAGES = ['dashboard', 'requests', 'villageAnalysis', 'profile'];

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
        });

        async function initializeApp() {
            // Protect this page (require executive or admin role)
            if (!window.AuthUtils.protectPage(['executive', 'admin'])) {
                return;
            }

            const authUser = window.AuthUtils.getCurrentUser();
            if (authUser && authUser.user) {
                try {
                    const userDetailsResponse = await window.AuthUtils.apiCall(`/api/admin/users/${encodeURIComponent(authUser.user.username)}`);
                    const userDetailsData = await userDetailsResponse.json();

                    if (userDetailsData.status === 'success' && userDetailsData.data) {
                        currentUser = {
                            username: userDetailsData.data.USERNAME,
                            role: userDetailsData.data.ROLE,
                            fullName: userDetailsData.data.FULL_NAME,
                            email: userDetailsData.data.EMAIL,
                            lastLogin: userDetailsData.data.LAST_LOGIN,
                            isActive: userDetailsData.data.IS_ACTIVE === 'TRUE',
                            token: authUser.token
                        };
                    } else {
                        currentUser = {
                            username: authUser.user.username,
                            role: authUser.user.role,
                            token: authUser.token,
                            fullName: authUser.user.username,
                            email: '-',
                            lastLogin: '-',
                            isActive: true
                        };
                    }
                } catch (error) {
                    console.error("Error fetching user details:", error);
                    currentUser = {
                        username: authUser.user.username,
                        role: authUser.user.role,
                        token: authUser.token,
                        fullName: authUser.user.username,
                        email: '-',
                        lastLogin: '-',
                        isActive: true
                    };
                }
                
                updateUserDisplay();
                await loadAllData();
                showDashboard();
                showToast('‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏ú‡∏π‡πâ‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°‡πÑ‡∏ü‡∏ü‡πâ‡∏≤! ‚ö°', 'success');
            } else {
                window.AuthUtils.forceLogout('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ');
            }
        }

        function updateUserDisplay() {
            if (currentUser) {
                document.getElementById('userDisplay').textContent = currentUser.username;
                document.getElementById('userName').textContent = currentUser.username;
                document.getElementById('userRole').textContent = getRoleDisplayName(currentUser.role);
                const avatar = document.getElementById('userAvatar');
                avatar.textContent = currentUser.username.charAt(0).toUpperCase();
            }
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏à‡∏≤‡∏Å API ‡∏à‡∏£‡∏¥‡∏á
        async function loadAllData() {
            try {
                showToast('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...', 'info');
                
                // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏π‡πà‡∏Ç‡∏ô‡∏≤‡∏ô
                await Promise.all([
                    loadRequests(),
                    loadPoles(),
                    loadUsers(),
                    loadSummary()
                ]);

                // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏£‡∏¥‡∏á
                calculateRealStatistics();
                
                // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•
                updateAllDisplays();
                
                // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏£‡∏≤‡∏ü
                createCharts();
                
                console.log('‚úÖ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß');
            } catch (error) {
                console.error('‚ùå Error loading data:', error);
                showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', 'error');
            }
        }

        // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°‡∏à‡∏≤‡∏Å API
        async function loadRequests() {
            try {
                const response = await window.AuthUtils.apiCall('/api/admin/repair-requests?limit=200');
                const data = await response.json();
                
                if (data.status === 'success') {
                    allRequests = data.data || [];
                    console.log(`‚úÖ ‡πÇ‡∏´‡∏•‡∏î‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°: ${allRequests.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`);
                } else {
                    throw new Error(data.message || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÑ‡∏î‡πâ');
                }
            } catch (error) {
                console.error('Error loading requests:', error);
                allRequests = [];
            }
        }

        // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏™‡∏≤‡πÑ‡∏ü‡∏ü‡πâ‡∏≤‡∏à‡∏≤‡∏Å API
        async function loadPoles() {
            try {
                const response = await window.AuthUtils.apiCall('/api/admin/poles');
                const data = await response.json();
                
                if (data.status === 'success') {
                    allPoles = data.data || [];
                    console.log(`‚úÖ ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏™‡∏≤‡πÑ‡∏ü‡∏ü‡πâ‡∏≤: ${allPoles.length} ‡πÄ‡∏™‡∏≤`);
                } else {
                    throw new Error(data.message || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏™‡∏≤‡πÑ‡∏ü‡∏ü‡πâ‡∏≤‡πÑ‡∏î‡πâ');
                }
            } catch (error) {
                console.error('Error loading poles:', error);
                allPoles = [];
            }
        }

        // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏à‡∏≤‡∏Å API
        async function loadUsers() {
            try {
                const response = await window.AuthUtils.apiCall('/api/admin/users');
                const data = await response.json();
                
                if (data.status === 'success') {
                    allUsers = data.data || [];
                    console.log(`‚úÖ ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ: ${allUsers.length} ‡∏Ñ‡∏ô`);
                } else {
                    throw new Error(data.message || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ');
                }
            } catch (error) {
                console.error('Error loading users:', error);
                allUsers = [];
            }
        }

        // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏£‡∏∏‡∏õ‡∏à‡∏≤‡∏Å API
        async function loadSummary() {
            try {
                const response = await window.AuthUtils.apiCall('/api/admin/dashboard-summary');
                const data = await response.json();
                
                if (data.status === 'success') {
                    console.log('‚úÖ ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏£‡∏∏‡∏õ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
                } else {
                    console.warn('‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏£‡∏∏‡∏õ‡πÑ‡∏î‡πâ');
                }
            } catch (error) {
                console.error('Error loading summary:', error);
            }
        }

        // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏£‡∏¥‡∏á
        function calculateRealStatistics() {
            if (!allRequests || allRequests.length === 0) {
                console.warn('‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥');
                return;
            }

            const now = new Date();
            const thisMonth = now.getMonth();
            const thisYear = now.getFullYear();

            // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô
            dashboardStats.total = allRequests.length;
            dashboardStats.pending = allRequests.filter(r => r.STATUS === '‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£').length;
            dashboardStats.approved = allRequests.filter(r => r.STATUS === '‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß‡∏£‡∏≠‡∏ä‡πà‡∏≤‡∏á').length;
            dashboardStats.rejected = allRequests.filter(r => r.STATUS === '‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÇ‡∏î‡∏¢‡∏ú‡∏π‡πâ‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£').length;

            // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÉ‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ
            const thisMonthRequests = allRequests.filter(request => {
                if (!request.DATE_REPORTED) return false;
                try {
                    const requestDate = parseDateFromThai(request.DATE_REPORTED);
                    return requestDate.getMonth() === thisMonth && requestDate.getFullYear() === thisYear;
                } catch (error) {
                    return false;
                }
            });
            dashboardStats.thisMonth = thisMonthRequests.length;

            // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏Ñ‡πâ‡∏≤‡∏á‡∏ô‡∏≤‡∏ô (‡πÄ‡∏Å‡∏¥‡∏ô 24 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á)
            dashboardStats.overdue = allRequests.filter(request => {
                if (request.STATUS !== '‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£') return false;
                try {
                    const requestDate = parseDateFromThai(request.DATE_REPORTED);
                    const hoursDiff = (now - requestDate) / (1000 * 60 * 60);
                    return hoursDiff > 24;
                } catch (error) {
                    return false;
                }
            }).length;

            // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥
            const processedRequests = allRequests.filter(r => 
                r.STATUS === '‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß‡∏£‡∏≠‡∏ä‡πà‡∏≤‡∏á' || r.STATUS === '‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÇ‡∏î‡∏¢‡∏ú‡∏π‡πâ‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£'
            );
            dashboardStats.approvalRate = processedRequests.length > 0 ? 
                Math.round((dashboardStats.approved / processedRequests.length) * 100) : 0;

            // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏Å‡∏≤‡∏£‡∏ï‡∏≠‡∏ö‡∏™‡∏ô‡∏≠‡∏á‡∏†‡∏≤‡∏¢‡πÉ‡∏ô 24 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á
            const respondedWithin24h = allRequests.filter(request => {
                if (!request.APPROVAL_TIMESTAMP || !request.DATE_REPORTED) return false;
                try {
                    const requestDate = parseDateFromThai(request.DATE_REPORTED);
                    const approvalDate = parseDateFromThai(request.APPROVAL_TIMESTAMP);
                    const hoursDiff = (approvalDate - requestDate) / (1000 * 60 * 60);
                    return hoursDiff <= 24;
                } catch (error) {
                    return false;
                }
            }).length;

            dashboardStats.avgResponseTime = processedRequests.length > 0 ?
                Math.round((respondedWithin24h / processedRequests.length) * 100) : 0;

            console.log('üìä ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏ó‡∏µ‡πà‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÑ‡∏î‡πâ:', dashboardStats);
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏≤‡∏Å‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÑ‡∏ó‡∏¢
        function parseDateFromThai(dateString) {
            if (!dateString) return new Date();
            
            try {
                // ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö: "8/6/2567, 14:30:25" ‡∏´‡∏£‡∏∑‡∏≠ "8/6/2567"
                const parts = dateString.split(/,\s*/);
                const datePart = parts[0].trim();
                const timePart = parts.length > 1 ? parts[1].trim() : '00:00:00';
                
                const dateSegments = datePart.split('/');
                if (dateSegments.length !== 3) return new Date();
                
                const day = parseInt(dateSegments[0]);
                const month = parseInt(dateSegments[1]) - 1; // JavaScript months are 0-indexed
                let year = parseInt(dateSegments[2]);
                
                // ‡πÅ‡∏õ‡∏•‡∏á ‡∏û.‡∏®. ‡πÄ‡∏õ‡πá‡∏ô ‡∏Ñ.‡∏®.
                if (year > 2500) year -= 543;
                
                const timeSegments = timePart.split(':');
                const hour = timeSegments.length > 0 ? parseInt(timeSegments[0]) : 0;
                const minute = timeSegments.length > 1 ? parseInt(timeSegments[1]) : 0;
                const second = timeSegments.length > 2 ? parseInt(timeSegments[2]) : 0;
                
                return new Date(year, month, day, hour, minute, second);
            } catch (error) {
                console.error('Error parsing date:', dateString, error);
                return new Date();
            }
        }

        // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
        function updateAllDisplays() {
            updateStatistics();
            updatePerformanceMetrics();
            updateNotificationBadge();
            updateAlerts();
            renderRecentRequests();
        }

        // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥
        function updateStatistics() {
            document.getElementById('totalCount').textContent = dashboardStats.total;
            document.getElementById('pendingCount').textContent = dashboardStats.pending;
            document.getElementById('approvedCount').textContent = dashboardStats.approved;
            document.getElementById('rejectedCount').textContent = dashboardStats.rejected;
            document.getElementById('quickPendingCount').textContent = dashboardStats.pending;
            document.getElementById('overdueCount').textContent = dashboardStats.overdue;
        }

        // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï performance metrics
        function updatePerformanceMetrics() {
            // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÄ‡∏ß‡∏•‡∏≤‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢ (‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á)
            const avgHours = Math.max(1, Math.min(48, 24 - (dashboardStats.approvalRate / 10)));
            document.getElementById('avgApprovalTime').textContent = Math.round(avgHours);
            
            document.getElementById('approvalRate').textContent = dashboardStats.approvalRate + '%';
            document.getElementById('responseTime').textContent = dashboardStats.avgResponseTime + '%';
            
            // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï progress bar
            const targetProgress = Math.min(dashboardStats.approvalRate, 100);
            document.getElementById('targetProgress').textContent = targetProgress + '%';
            document.getElementById('targetProgressBar').style.width = targetProgress + '%';
        }

        // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï notification badge
        function updateNotificationBadge() {
            const badge = document.getElementById('notificationBadge');
            const urgentCount = dashboardStats.pending + dashboardStats.overdue;
            
            if (urgentCount > 0) {
                badge.style.display = 'flex';
                badge.textContent = urgentCount > 9 ? '9+' : urgentCount;
            } else {
                badge.style.display = 'none';
            }
        }

        // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
        function updateAlerts() {
            const alertsSection = document.getElementById('alertsSection');
            const alertsList = document.getElementById('alertsList');
            
            const alerts = [];
            
            // ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏Ñ‡πâ‡∏≤‡∏á‡∏ô‡∏≤‡∏ô
            if (dashboardStats.overdue > 0) {
                alerts.push({
                    icon: '‚ö†Ô∏è',
                    title: '‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏Ñ‡πâ‡∏≤‡∏á‡∏ô‡∏≤‡∏ô',
                    description: `‡∏°‡∏µ‡∏Ñ‡∏≥‡∏Ç‡∏≠ ${dashboardStats.overdue} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏Ñ‡πâ‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÄ‡∏Å‡∏¥‡∏ô 24 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á`,
                    action: () => showOverdueRequests()
                });
            }
            
            // ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏°‡∏≤‡∏Å
            if (dashboardStats.pending > 10) {
                alerts.push({
                    icon: 'üìã',
                    title: '‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏°‡∏≤‡∏Å',
                    description: `‡∏°‡∏µ‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ ${dashboardStats.pending} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`,
                    action: () => showPendingRequests()
                });
            }
            
            // ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ñ‡πâ‡∏≤‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏ï‡πà‡∏≥
            if (dashboardStats.approvalRate < 70 && dashboardStats.total > 5) {
                alerts.push({
                    icon: 'üìâ',
                    title: '‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏ï‡πà‡∏≥',
                    description: `‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÄ‡∏û‡∏µ‡∏¢‡∏á ${dashboardStats.approvalRate}% ‡∏Ñ‡∏ß‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö`,
                    action: () => showRequestsPage()
                });
            }
            
            if (alerts.length > 0) {
                alertsList.innerHTML = alerts.map(alert => `
                    <div class="alert-card" onclick="(${alert.action.toString()})()">
                        <div class="alert-icon">${alert.icon}</div>
                        <div class="alert-content">
                            <div class="alert-title">${alert.title}</div>
                            <div class="alert-description">${alert.description}</div>
                        </div>
                    </div>
                `).join('');
                alertsSection.style.display = 'block';
            } else {
                alertsSection.style.display = 'none';
            }
        }

        // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏£‡∏≤‡∏ü‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏£‡∏¥‡∏á
        function createCharts() {
            createTrendChart();
            calculateVillageStatistics();
        }

        // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏£‡∏≤‡∏ü‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°
        function createTrendChart() {
            const ctx = document.getElementById('trendChart');
            if (!ctx) return;

            // ‡∏à‡∏±‡∏î‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏°‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå
            const weeklyData = getWeeklyData();
            
            if (trendChart) {
                trendChart.destroy();
            }

            trendChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: weeklyData.labels,
                    datasets: [{
                        label: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏≥‡∏Ç‡∏≠',
                        data: weeklyData.data,
                        borderColor: '#fbbf24',
                        backgroundColor: 'rgba(251, 191, 36, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4,
                        pointBackgroundColor: '#fbbf24',
                        pointBorderColor: '#f59e0b',
                        pointRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: {
                                color: '#f8fafc'
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                color: '#94a3b8'
                            },
                            grid: {
                                color: 'rgba(148, 163, 184, 0.1)'
                            }
                        },
                        x: {
                            ticks: {
                                color: '#94a3b8'
                            },
                            grid: {
                                color: 'rgba(148, 163, 184, 0.1)'
                            }
                        }
                    }
                }
            });
        }

        // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏¢‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå
        function getWeeklyData() {
            const weeks = [];
            const data = [];
            const now = new Date();
            
            // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• 8 ‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á
            for (let i = 7; i >= 0; i--) {
                const weekStart = new Date(now);
                weekStart.setDate(now.getDate() - (i * 7));
                weekStart.setHours(0, 0, 0, 0);
                
                const weekEnd = new Date(weekStart);
                weekEnd.setDate(weekStart.getDate() + 6);
                weekEnd.setHours(23, 59, 59, 999);
                
                const requestsInWeek = allRequests.filter(request => {
                    if (!request.DATE_REPORTED) return false;
                    try {
                        const requestDate = parseDateFromThai(request.DATE_REPORTED);
                        return requestDate >= weekStart && requestDate <= weekEnd;
                    } catch (error) {
                        return false;
                    }
                }).length;
                
                weeks.push(`${weekStart.getDate()}/${weekStart.getMonth() + 1}`);
                data.push(requestsInWeek);
            }
            
            return { labels: weeks, data: data };
        }

        // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏´‡∏°‡∏π‡πà‡∏ö‡πâ‡∏≤‡∏ô
        function calculateVillageStatistics() {
            const villageStats = {};
            
            allRequests.forEach(request => {
                const village = request.MOO || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
                if (!villageStats[village]) {
                    villageStats[village] = {
                        total: 0,
                        pending: 0,
                        approved: 0,
                        rejected: 0
                    };
                }
                
                villageStats[village].total++;
                if (request.STATUS === '‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£') villageStats[village].pending++;
                else if (request.STATUS === '‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß‡∏£‡∏≠‡∏ä‡πà‡∏≤‡∏á') villageStats[village].approved++;
                else if (request.STATUS === '‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÇ‡∏î‡∏¢‡∏ú‡∏π‡πâ‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£') villageStats[village].rejected++;
            });
            
            const villageCount = Object.keys(villageStats).length;
            document.getElementById('villageCount').textContent = villageCount;
            
            // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏ß‡πâ‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏´‡∏°‡∏π‡πà‡∏ö‡πâ‡∏≤‡∏ô
            window.villageStats = villageStats;
        }

        // ‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
        function renderRecentRequests() {
            const container = document.getElementById('recentRequests');
            if (!container) return;
            
            const recentRequests = allRequests
                .sort((a, b) => {
                    const dateA = parseDateFromThai(a.DATE_REPORTED);
                    const dateB = parseDateFromThai(b.DATE_REPORTED);
                    return dateB - dateA;
                })
                .slice(0, 5);
            
            if (recentRequests.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">üí°</div>
                        <p>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏Ç‡∏≠</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = recentRequests.map(request => {
                const isOverdue = checkIfOverdue(request);
                const timeAgo = getTimeAgo(request.DATE_REPORTED);
                
                return `
                    <div class="request-card" onclick='showRequestDetail("${request.REQUEST_ID}")'>
                        <div class="request-header">
                            <span class="request-id">üé´ ${request.REQUEST_ID}</span>
                            <span class="status-badge ${isOverdue ? 'status-overdue' : getStatusClass(request.STATUS)}">
                                ${isOverdue ? '‡∏Ñ‡πâ‡∏≤‡∏á‡∏ô‡∏≤‡∏ô' : (request.STATUS || '‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£')}
                            </span>
                        </div>
                        <div class="request-info">
                            <span class="request-info-icon">üë§</span>
                            <span style="color: #f8fafc;">${request.TITLE_PREFIX || ''} ${request.FIRST_NAME || ''} ${request.LAST_NAME || ''}</span>
                        </div>
                        <div class="request-info">
                            <span class="request-info-icon">üìç</span>
                            <span>‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà ${request.HOUSE_NO || '-'}, ‡∏´‡∏°‡∏π‡πà ${request.MOO || '-'}</span>
                        </div>
                        <div class="request-info">
                            <span class="request-info-icon">‚è∞</span>
                            <span>${timeAgo}</span>
                        </div>
                        <p class="request-reason">
                            <strong style="color: #fbbf24;">‡∏õ‡∏±‡∏ç‡∏´‡∏≤:</strong> ${request.REASON || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}
                        </p>
                        <p style="color: #10b981; font-size: 0.9rem; font-weight: 500; margin-top: 1rem; text-align: right;">
                            ‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î ‚Üí
                        </p>
                    </div>
                `;
            }).join('');
        }

        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏Ñ‡πâ‡∏≤‡∏á‡∏ô‡∏≤‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
        function checkIfOverdue(request) {
            if (request.STATUS !== '‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£') return false;
            try {
                const requestDate = parseDateFromThai(request.DATE_REPORTED);
                const hoursDiff = (new Date() - requestDate) / (1000 * 60 * 60);
                return hoursDiff > 24;
            } catch (error) {
                return false;
            }
        }

        // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏ú‡πà‡∏≤‡∏ô‡∏°‡∏≤
        function getTimeAgo(dateString) {
            try {
                const requestDate = parseDateFromThai(dateString);
                const now = new Date();
                const diffMs = now - requestDate;
                const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
                const diffDays = Math.floor(diffHours / 24);
                
                if (diffDays > 0) {
                    return `${diffDays} ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß`;
                } else if (diffHours > 0) {
                    return `${diffHours} ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß`;
                } else {
                    const diffMinutes = Math.floor(diffMs / (1000 * 60));
                    return `${Math.max(1, diffMinutes)} ‡∏ô‡∏≤‡∏ó‡∏µ‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß`;
                }
            } catch (error) {
                return '‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö';
            }
        }

        // ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Ñ‡∏≥‡∏Ç‡∏≠
        function showRequestDetail(requestId) {
            const request = allRequests.find(r => r.REQUEST_ID === requestId);
            if (!request) {
                showToast('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏≥‡∏Ç‡∏≠', 'error');
                return;
            }
            
            const isOverdue = checkIfOverdue(request);
            const timeAgo = getTimeAgo(request.DATE_REPORTED);
            const isPending = request.STATUS === '‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£';
            
            // ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏õ‡∏∏‡πà‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥/‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥
            let actionButtons = '';
            if (isPending && currentUser && (currentUser.role === 'executive' || currentUser.role === 'admin')) {
                actionButtons = `
                    <div style="display: flex; gap: 0.5rem; margin-top: 1.5rem; justify-content: center;">
                        <button onclick="approveRequest('${requestId}')" style="background: linear-gradient(135deg, #10b981, #059669); color: white; border: none; border-radius: 0.5rem; padding: 0.75rem 1.5rem; font-weight: 600; cursor: pointer; transition: all 0.3s ease; font-size: 0.9rem;">
                            ‚úÖ ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏Ñ‡∏≥‡∏Ç‡∏≠
                        </button>
                        <button onclick="rejectRequest('${requestId}')" style="background: linear-gradient(135deg, #ef4444, #dc2626); color: white; border: none; border-radius: 0.5rem; padding: 0.75rem 1.5rem; font-weight: 600; cursor: pointer; transition: all 0.3s ease; font-size: 0.9rem;">
                            ‚ùå ‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥
                        </button>
                    </div>
                `;
            }
            
            // ‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î
            Swal.fire({
                title: `üé´ ${request.REQUEST_ID}`,
                html: `
                    <div style="text-align: left; color: #f8fafc; line-height: 1.6;">
                        <div style="background: linear-gradient(135deg, rgba(251, 191, 36, 0.1), rgba(245, 158, 11, 0.05)); padding: 1rem; border-radius: 0.5rem; margin-bottom: 1rem; border: 1px solid rgba(251, 191, 36, 0.2);">
                            <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                                <span style="font-size: 1rem;">üìä</span>
                                <strong style="color: #fbbf24;">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞:</strong>
                                <span class="status-badge ${isOverdue ? 'status-overdue' : getStatusClass(request.STATUS)}" style="font-size: 0.75rem; padding: 0.25rem 0.5rem; border-radius: 50px;">
                                    ${isOverdue ? '‡∏Ñ‡πâ‡∏≤‡∏á‡∏ô‡∏≤‡∏ô' : (request.STATUS || '‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£')}
                                </span>
                            </div>
                            <div style="color: #e2e8f0; font-size: 0.9rem;">‚è∞ ${timeAgo}</div>
                        </div>
                        
                        <div style="display: grid; gap: 0.75rem;">
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <span style="color: #fbbf24;">üë§</span>
                                <strong style="color: #cbd5e1;">‡∏ú‡∏π‡πâ‡πÅ‡∏à‡πâ‡∏á:</strong> 
                                <span style="color: #f8fafc;">${request.TITLE_PREFIX || ''} ${request.FIRST_NAME || ''} ${request.LAST_NAME || ''}</span>
                            </div>
                            
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <span style="color: #fbbf24;">üìû</span>
                                <strong style="color: #cbd5e1;">‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå:</strong> 
                                <span style="color: #f8fafc;">${request.PHONE || '-'}</span>
                            </div>
                            
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <span style="color: #fbbf24;">üìç</span>
                                <strong style="color: #cbd5e1;">‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà:</strong> 
                                <span style="color: #f8fafc;">‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà ${request.HOUSE_NO || '-'}, ‡∏´‡∏°‡∏π‡πà ${request.MOO || '-'}</span>
                            </div>
                            
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <span style="color: #fbbf24;">‚ö°</span>
                                <strong style="color: #cbd5e1;">‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏™‡∏≤:</strong> 
                                <span style="color: #f8fafc;">${request.POLE_ID || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}</span>
                            </div>
                            
                            <div style="display: flex; align-items: flex-start; gap: 0.5rem;">
                                <span style="color: #fbbf24;">üîß</span>
                                <strong style="color: #cbd5e1;">‡∏õ‡∏±‡∏ç‡∏´‡∏≤:</strong> 
                                <span style="color: #f8fafc; flex: 1;">${request.REASON || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}</span>
                            </div>
                            
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <span style="color: #fbbf24;">üìÖ</span>
                                <strong style="color: #cbd5e1;">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏à‡πâ‡∏á:</strong> 
                                <span style="color: #f8fafc;">${formatDateThai(request.DATE_REPORTED)}</span>
                            </div>
                            
                            ${request.APPROVED_BY ? `
                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                    <span style="color: #10b981;">üëë</span>
                                    <strong style="color: #cbd5e1;">‡∏ú‡∏π‡πâ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥:</strong> 
                                    <span style="color: #10b981;">${request.APPROVED_BY}</span>
                                </div>
                            ` : ''}
                            
                            ${request.APPROVAL_TIMESTAMP ? `
                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                    <span style="color: #10b981;">‚è∞</span>
                                    <strong style="color: #cbd5e1;">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥:</strong> 
                                    <span style="color: #10b981;">${formatDateThai(request.APPROVAL_TIMESTAMP)}</span>
                                </div>
                            ` : ''}
                            
                            ${request.TECHNICIAN_NOTES ? `
                                <div style="background: rgba(15, 23, 42, 0.3); padding: 1rem; border-radius: 0.5rem; border-left: 4px solid #fbbf24; margin-top: 0.5rem;">
                                    <div style="display: flex; align-items: flex-start; gap: 0.5rem;">
                                        <span style="color: #fbbf24;">üìù</span>
                                        <div>
                                            <strong style="color: #cbd5e1;">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏:</strong>
                                            <div style="color: #f8fafc; margin-top: 0.25rem;">${request.TECHNICIAN_NOTES}</div>
                                        </div>
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                        
                        ${actionButtons}
                    </div>
                `,
                showConfirmButton: true,
                confirmButtonText: '‡∏õ‡∏¥‡∏î',
                showCloseButton: true,
                width: '95%',
                maxWidth: '500px',
                customClass: {
                    popup: 'request-detail-popup'
                }
            });
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏Ñ‡∏≥‡∏Ç‡∏≠
        async function approveRequest(requestId) {
            try {
                showSignatureModal(requestId, 'approve');
            } catch (error) {
                console.error('Error showing approval modal:', error);
                showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥', 'error');
            }
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏Ñ‡∏≥‡∏Ç‡∏≠
        async function rejectRequest(requestId) {
            try {
                const { value: reason } = await Swal.fire({
                    title: '‚ùå ‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏Ñ‡∏≥‡∏Ç‡∏≠',
                    html: `
                        <div style="text-align: left; color: #f8fafc; margin-bottom: 1rem;">
                            <p style="margin-bottom: 1rem;">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏Ñ‡∏≥‡∏Ç‡∏≠ <strong>${requestId}</strong></p>
                        </div>
                    `,
                    input: 'textarea',
                    inputPlaceholder: '‡πÄ‡∏ä‡πà‡∏ô: ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô, ‡πÑ‡∏°‡πà‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏Ç‡∏≠‡∏ö‡πÄ‡∏Ç‡∏ï‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö, ‡∏Ø‡∏•‡∏Ø',
                    inputAttributes: {
                        style: 'background: rgba(15, 23, 42, 0.7); color: #f8fafc; border: 1px solid rgba(251, 191, 36, 0.3); border-radius: 0.5rem; padding: 0.75rem; min-height: 100px;'
                    },
                    showCancelButton: true,
                    confirmButtonText: 'üö´ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥',
                    cancelButtonText: '‚Ü©Ô∏è ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å',
                    reverseButtons: true,
                    inputValidator: (value) => {
                        if (!value || value.trim().length < 10) {
                            return '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 10 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£';
                        }
                    },
                    customClass: {
                        popup: 'signature-modal'
                    }
                });

                if (reason) {
                    // ‡πÅ‡∏™‡∏î‡∏á loading
                    Swal.fire({
                        title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...',
                        html: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà',
                        allowOutsideClick: false,
                        showConfirmButton: false,
                        didOpen: () => {
                            Swal.showLoading();
                        }
                    });

                    const success = await updateRequestStatus(requestId, '‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÇ‡∏î‡∏¢‡∏ú‡∏π‡πâ‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£', reason.trim());
                    
                    if (success) {
                        Swal.fire({
                            icon: 'success',
                            title: '‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!',
                            text: `‡∏Ñ‡∏≥‡∏Ç‡∏≠ ${requestId} ‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß`,
                            confirmButtonText: '‡∏ï‡∏Å‡∏•‡∏á'
                        });
                        
                        // ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                        await loadAllData();
                        updateAllDisplays();
                    } else {
                        throw new Error('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÑ‡∏î‡πâ');
                    }
                }
            } catch (error) {
                console.error('Error rejecting request:', error);
                Swal.fire({
                    icon: 'error',
                    title: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î',
                    text: '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÑ‡∏î‡πâ: ' + error.message,
                    confirmButtonText: '‡∏ï‡∏Å‡∏•‡∏á'
                });
            }
        }

        // ‡πÅ‡∏™‡∏î‡∏á modal ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ß‡∏≤‡∏î‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô
        function showSignatureModal(requestId, action) {
            const actionText = action === 'approve' ? '‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥' : '‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥';
            const actionIcon = action === 'approve' ? '‚úÖ' : '‚ùå';
            
            Swal.fire({
                title: `${actionIcon} ${actionText}‡∏Ñ‡∏≥‡∏Ç‡∏≠`,
                html: `
                    <div class="signature-container">
                        <div class="signature-header">
                            <div class="signature-title">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ß‡∏≤‡∏î‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</div>
                            <div class="signature-subtitle">‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà: ${requestId}</div>
                        </div>
                        
                        <div class="signature-canvas-container">
                            <canvas id="signatureCanvas" class="signature-canvas" width="400" height="200"></canvas>
                            <div id="signaturePlaceholder" class="signature-placeholder">
                                ‚úçÔ∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏ã‡πá‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡πÉ‡∏ô‡∏Å‡∏£‡∏≠‡∏ö‡∏ô‡∏µ‡πâ
                            </div>
                        </div>
                        
                        <div class="signature-controls">
                            <button type="button" class="signature-clear-btn" onclick="clearSignature()">
                                üóëÔ∏è ‡∏•‡πâ‡∏≤‡∏á‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô
                            </button>
                            <div class="signature-actions">
                                <button type="button" class="signature-cancel-btn" onclick="Swal.close()">
                                    ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                                </button>
                                <button type="button" id="signatureSubmitBtn" class="signature-submit-btn" onclick="submitSignature('${requestId}', '${action}')" disabled>
                                    ${actionIcon} ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô${actionText}
                                </button>
                            </div>
                        </div>
                    </div>
                `,
                showConfirmButton: false,
                showCancelButton: false,
                allowOutsideClick: false,
                customClass: {
                    popup: 'signature-modal'
                },
                didOpen: () => {
                    initializeSignaturePad();
                }
            });
        }

        // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô signature pad
        function initializeSignaturePad() {
            const canvas = document.getElementById('signatureCanvas');
            const placeholder = document.getElementById('signaturePlaceholder');
            const submitBtn = document.getElementById('signatureSubmitBtn');
            
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            let drawing = false;
            let hasSignature = false;
            
            // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ canvas
            ctx.strokeStyle = '#1e293b';
            ctx.lineWidth = 2;
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
            
            // Mouse events
            canvas.addEventListener('mousedown', startDrawing);
            canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('mouseup', stopDrawing);
            canvas.addEventListener('mouseout', stopDrawing);
            
            // Touch events
            canvas.addEventListener('touchstart', handleTouch);
            canvas.addEventListener('touchmove', handleTouch);
            canvas.addEventListener('touchend', stopDrawing);
            
            function startDrawing(e) {
                drawing = true;
                isDrawing = true;
                const rect = canvas.getBoundingClientRect();
                const x = (e.clientX || e.touches[0].clientX) - rect.left;
                const y = (e.clientY || e.touches[0].clientY) - rect.top;
                ctx.beginPath();
                ctx.moveTo(x, y);
                
                // ‡∏ã‡πà‡∏≠‡∏ô placeholder
                placeholder.style.display = 'none';
                canvas.classList.add('drawing');
            }
            
            function draw(e) {
                if (!drawing) return;
                e.preventDefault();
                
                const rect = canvas.getBoundingClientRect();
                const x = (e.clientX || e.touches[0].clientX) - rect.left;
                const y = (e.clientY || e.touches[0].clientY) - rect.top;
                
                ctx.lineTo(x, y);
                ctx.stroke();
                
                hasSignature = true;
                submitBtn.disabled = false;
            }
            
            function stopDrawing() {
                drawing = false;
                isDrawing = false;
                canvas.classList.remove('drawing');
            }
            
            function handleTouch(e) {
                e.preventDefault();
                const touch = e.touches[0];
                const mouseEvent = new MouseEvent(e.type === 'touchstart' ? 'mousedown' : 
                                                 e.type === 'touchmove' ? 'mousemove' : 'mouseup', {
                    clientX: touch.clientX,
                    clientY: touch.clientY
                });
                canvas.dispatchEvent(mouseEvent);
            }
            
            // ‡πÄ‡∏Å‡πá‡∏ö reference
            signaturePad = {
                canvas: canvas,
                ctx: ctx,
                placeholder: placeholder,
                hasSignature: () => hasSignature,
                clear: () => {
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    hasSignature = false;
                    submitBtn.disabled = true;
                    placeholder.style.display = 'block';
                },
                getDataURL: () => canvas.toDataURL('image/png')
            };
        }

        // ‡∏•‡πâ‡∏≤‡∏á‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô
        function clearSignature() {
            if (signaturePad) {
                signaturePad.clear();
            }
        }

        // ‡∏™‡πà‡∏á‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô‡πÅ‡∏•‡∏∞‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥
        async function submitSignature(requestId, action) {
            try {
                if (!signaturePad || !signaturePad.hasSignature()) {
                    showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ß‡∏≤‡∏î‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô', 'warning');
                    return;
                }

                // ‡πÅ‡∏™‡∏î‡∏á loading
                Swal.fire({
                    title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...',
                    html: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà',
                    allowOutsideClick: false,
                    showConfirmButton: false,
                    didOpen: () => {
                        Swal.showLoading();
                    }
                });

                // ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô
                const signatureDataURL = signaturePad.getDataURL();
                const signatureUrl = await uploadSignature(signatureDataURL, requestId);
                
                if (!signatureUrl) {
                    throw new Error('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô‡πÑ‡∏î‡πâ');
                }

                // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ñ‡∏≥‡∏Ç‡∏≠
                const newStatus = action === 'approve' ? '‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß‡∏£‡∏≠‡∏ä‡πà‡∏≤‡∏á' : '‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÇ‡∏î‡∏¢‡∏ú‡∏π‡πâ‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£';
                const success = await updateRequestStatusWithSignature(requestId, newStatus, '', signatureUrl);
                
                if (success) {
                    const actionText = action === 'approve' ? '‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥' : '‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥';
                    Swal.fire({
                        icon: 'success',
                        title: `${actionText}‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!`,
                        text: `‡∏Ñ‡∏≥‡∏Ç‡∏≠ ${requestId} ‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£${actionText}‡πÅ‡∏•‡πâ‡∏ß`,
                        confirmButtonText: '‡∏ï‡∏Å‡∏•‡∏á'
                    });
                    
                    // ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                    await loadAllData();
                    updateAllDisplays();
                } else {
                    throw new Error('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÑ‡∏î‡πâ');
                }
                
            } catch (error) {
                console.error('Error submitting signature:', error);
                Swal.fire({
                    icon: 'error',
                    title: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î',
                    text: '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô‡πÑ‡∏î‡πâ: ' + error.message,
                    confirmButtonText: '‡∏ï‡∏Å‡∏•‡∏á'
                });
            }
        }

        // ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô‡πÑ‡∏õ Google Drive
        async function uploadSignature(signatureDataURL, requestId) {
            try {
                const response = await window.AuthUtils.apiCall('/api/admin/upload-signature', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        imageDataUrl: signatureDataURL,
                        fileNamePrefix: `approval_${requestId}`
                    })
                });

                const data = await response.json();
                if (data.status === 'success') {
                    console.log('‚úÖ Signature uploaded successfully:', data.signatureUrl);
                    return data.signatureUrl;
                } else {
                    throw new Error(data.message || 'Failed to upload signature');
                }
            } catch (error) {
                console.error('‚ùå Error uploading signature:', error);
                throw error;
            }
        }

        // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô
        async function updateRequestStatusWithSignature(requestId, newStatus, notes, signatureUrl) {
            try {
                const response = await window.AuthUtils.apiCall(`/api/admin/repair-request/${requestId}/status`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        newStatus: newStatus,
                        technicianNotes: notes || '',
                        signatureUrl: signatureUrl,
                        approvalTimestampClient: new Date().toLocaleString('th-TH', { timeZone: 'Asia/Bangkok' })
                    })
                });

                const data = await response.json();
                if (data.status === 'success') {
                    console.log('‚úÖ Request status updated successfully');
                    return true;
                } else {
                    throw new Error(data.message || 'Failed to update request status');
                }
            } catch (error) {
                console.error('‚ùå Error updating request status:', error);
                throw error;
            }
        }

        // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ñ‡∏≥‡∏Ç‡∏≠ (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥)
        async function updateRequestStatus(requestId, newStatus, notes) {
            try {
                const response = await window.AuthUtils.apiCall(`/api/admin/repair-request/${requestId}/status`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        newStatus: newStatus,
                        technicianNotes: notes || '',
                        approvalTimestampClient: new Date().toLocaleString('th-TH', { timeZone: 'Asia/Bangkok' })
                    })
                });

                const data = await response.json();
                if (data.status === 'success') {
                    console.log('‚úÖ Request status updated successfully');
                    return true;
                } else {
                    throw new Error(data.message || 'Failed to update request status');
                }
            } catch (error) {
                console.error('‚ùå Error updating request status:', error);
                throw error;
            }
        }

        // ‡∏à‡∏±‡∏î‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà
        function formatDateThai(dateString) {
            try {
                if (!dateString) return '-';
                const date = parseDateFromThai(dateString);
                return date.toLocaleDateString('th-TH', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            } catch (error) {
                return dateString;
            }
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡∏ó‡∏≤‡∏á
        function setActivePage(pageId, title) {
            document.getElementById('pageTitle').textContent = title;
            PAGES.forEach(page => {
                const pageElement = document.getElementById(page + 'Page');
                if (pageElement) pageElement.classList.add('hidden');
            });
            const activePageElement = document.getElementById(pageId + 'Page');
            if (activePageElement) activePageElement.classList.remove('hidden');

            // Update navigation
            document.querySelectorAll('.nav-item').forEach((item, index) => {
                item.classList.remove('active');
                if ((pageId === 'dashboard' && index === 0) ||
                    (pageId === 'requests' && index === 1) ||
                    (pageId === 'villageAnalysis' && index === 2) ||
                    (pageId === 'reports' && index === 3) ||
                    (pageId === 'profile' && index === 4)) {
                    item.classList.add('active');
                }
            });
        }

        function showDashboard() {
            setActivePage('dashboard', '‡∏£‡∏∞‡∏ö‡∏ö‡∏ú‡∏π‡πâ‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£');
        }

        function showRequestsPage() {
            setActivePage('requests', '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏Ç‡∏≠');
            renderAllRequests();
        }

        function showVillageAnalysis() {
            setActivePage('villageAnalysis', '‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà');
            renderVillageAnalysis();
            createVillageChart();
        }

        function showProfilePage() {
            setActivePage('profile', '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß');
            populateProfilePage();
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó
        function showAllRequests() {
            showRequestsPage();
            document.getElementById('statusFilter').value = 'all';
            filterRequests();
        }

        function showPendingRequests() {
            showRequestsPage();
            document.getElementById('statusFilter').value = '‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£';
            filterRequests();
        }

        function showApprovedRequests() {
            showRequestsPage();
            document.getElementById('statusFilter').value = '‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß‡∏£‡∏≠‡∏ä‡πà‡∏≤‡∏á';
            filterRequests();
        }

        function showRejectedRequests() {
            showRequestsPage();
            document.getElementById('statusFilter').value = '‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÇ‡∏î‡∏¢‡∏ú‡∏π‡πâ‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£';
            filterRequests();
        }

        function showOverdueRequests() {
            showRequestsPage();
            // ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏Ñ‡πâ‡∏≤‡∏á‡∏ô‡∏≤‡∏ô
            const overdueRequests = allRequests.filter(checkIfOverdue);
            renderFilteredRequests(overdueRequests);
        }

        // ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
        function renderAllRequests() {
            filterRequests();
        }

        // ‡∏Å‡∏£‡∏≠‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏ï‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
        function filterRequests() {
            const status = document.getElementById('statusFilter').value;
            let filteredRequests = allRequests;
            
            if (status !== 'all') {
                filteredRequests = allRequests.filter(r => r.STATUS === status);
            }
            
            renderFilteredRequests(filteredRequests);
        }

        // ‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏ó‡∏µ‡πà‡∏Å‡∏£‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß
        function renderFilteredRequests(requests) {
            const container = document.getElementById('requestsList');
            if (!container) return;
            
            if (requests.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">‚úÖ</div>
                        <p>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç</p>
                    </div>
                `;
                return;
            }
            
            const sortedRequests = requests.sort((a, b) => {
                const dateA = parseDateFromThai(a.DATE_REPORTED);
                const dateB = parseDateFromThai(b.DATE_REPORTED);
                return dateB - dateA;
            });
            
            container.innerHTML = sortedRequests.map(request => {
                const isOverdue = checkIfOverdue(request);
                const timeAgo = getTimeAgo(request.DATE_REPORTED);
                
                return `
                    <div class="request-card" onclick='showRequestDetail("${request.REQUEST_ID}")'>
                        <div class="request-header">
                            <span class="request-id">üé´ ${request.REQUEST_ID}</span>
                            <span class="status-badge ${isOverdue ? 'status-overdue' : getStatusClass(request.STATUS)}">
                                ${isOverdue ? '‡∏Ñ‡πâ‡∏≤‡∏á‡∏ô‡∏≤‡∏ô' : (request.STATUS || '‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£')}
                            </span>
                        </div>
                        
                        <div class="request-info">
                            <span class="request-info-icon">üë§</span>
                            <span>${request.TITLE_PREFIX || ''} ${request.FIRST_NAME || ''} ${request.LAST_NAME || ''}</span>
                        </div>
                        
                        <div class="request-info">
                            <span class="request-info-icon">üìû</span>
                            <span>${request.PHONE || '-'}</span>
                        </div>
                        
                        <div class="request-info">
                            <span class="request-info-icon">üìç</span>
                            <span>‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà ${request.HOUSE_NO || '-'}, ‡∏´‡∏°‡∏π‡πà ${request.MOO || '-'}</span>
                        </div>
                        
                        <div class="request-info">
                            <span class="request-info-icon">‚è∞</span>
                            <span>${timeAgo}</span>
                        </div>
                        
                        ${request.APPROVED_BY ? `
                            <div class="request-info">
                                <span class="request-info-icon">üëë</span>
                                <span>‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÇ‡∏î‡∏¢ ${request.APPROVED_BY}</span>
                            </div>
                        ` : ''}
                        
                        <p class="request-reason">
                            <strong>‡∏õ‡∏±‡∏ç‡∏´‡∏≤:</strong> ${request.REASON || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}
                        </p>
                    </div>
                `;
            }).join('');
        }

        // ‡πÅ‡∏™‡∏î‡∏á‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏´‡∏°‡∏π‡πà‡∏ö‡πâ‡∏≤‡∏ô
        function renderVillageAnalysis() {
            if (!window.villageStats) {
                calculateVillageStatistics();
            }
            
            const sortedVillages = Object.entries(window.villageStats)
                .sort((a, b) => b[1].total - a[1].total)
                .slice(0, 15); // ‡πÅ‡∏™‡∏î‡∏á‡πÅ‡∏Ñ‡πà 15 ‡∏´‡∏°‡∏π‡πà‡∏ö‡πâ‡∏≤‡∏ô‡πÅ‡∏£‡∏Å
            
            const container = document.getElementById('villageStatsList');
            container.innerHTML = sortedVillages.map(([village, stats]) => `
                <div class="village-item">
                    <div>
                        <div class="village-name">‡∏´‡∏°‡∏π‡πà ${village}</div>
                        <div class="village-stats">
                            ‡∏£‡∏≠: ${stats.pending} | ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥: ${stats.approved} | ‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò: ${stats.rejected}
                        </div>
                    </div>
                    <div class="village-count">${stats.total}</div>
                </div>
            `).join('');
        }

        // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏£‡∏≤‡∏ü‡πÅ‡∏™‡∏î‡∏á‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏à‡∏≤‡∏¢‡∏ï‡∏±‡∏ß‡∏Ç‡∏≠‡∏á‡∏´‡∏°‡∏π‡πà‡∏ö‡πâ‡∏≤‡∏ô
        function createVillageChart() {
            const ctx = document.getElementById('villageDistributionChart');
            if (!ctx || !window.villageStats) return;
            
            const sortedVillages = Object.entries(window.villageStats)
                .sort((a, b) => b[1].total - a[1].total)
                .slice(0, 10);
            
            if (villageChart) {
                villageChart.destroy();
            }
            
            villageChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: sortedVillages.map(([village]) => `‡∏´‡∏°‡∏π‡πà ${village}`),
                    datasets: [{
                        data: sortedVillages.map(([, stats]) => stats.total),
                        backgroundColor: [
                            '#fbbf24', '#f59e0b', '#d97706', '#92400e',
                            '#10b981', '#059669', '#047857', '#065f46',
                            '#3b82f6', '#2563eb'
                        ],
                        borderColor: '#1e293b',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                color: '#f8fafc',
                                padding: 15,
                                usePointStyle: true
                            }
                        }
                    }
                }
            });
        }

        // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô PDF
        async function generateReport() {
            try {
                // ‡πÅ‡∏™‡∏î‡∏á loading
                Swal.fire({
                    title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô...',
                    html: `
                        <div style="display: flex; align-items: center; justify-content: center; gap: 1rem; color: #e2e8f0;">
                            <div style="font-size: 2rem;">üìÑ</div>
                            <div>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà</div>
                        </div>
                    `,
                    allowOutsideClick: false,
                    showConfirmButton: false,
                    didOpen: () => {
                        Swal.showLoading();
                    }
                });
                
                // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡∏≠‡∏á‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
                const now = new Date();
                const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
                const endOfMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0);
                
                // ‡∏™‡∏£‡πâ‡∏≤‡∏á request body
                const requestBody = {
                    filterStatus: '', // ‡∏ó‡∏∏‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
                    dateRange: {
                        start: startOfMonth.toISOString(),
                        end: endOfMonth.toISOString()
                    },
                    templateOptions: {
                        title: `‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏£‡∏∏‡∏õ‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡πÄ‡∏î‡∏∑‡∏≠‡∏ô ${now.toLocaleDateString('th-TH', { month: 'long', year: 'numeric' })}`,
                        showDate: true,
                        headerColor: '#fbbf24',
                        includeStats: true,
                        includeCharts: false
                    }
                };

                console.log('üì§ ‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô:', requestBody);

                const response = await window.AuthUtils.apiCall('/api/admin/reports/repair-requests/pdf', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                });

                if (response.ok) {
                    const blob = await response.blob();
                    
                    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÑ‡∏î‡πâ PDF ‡∏à‡∏£‡∏¥‡∏á‡πÜ
                    if (blob.type === 'application/pdf' || blob.size > 0) {
                        // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        
                        const fileName = `‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ú‡∏π‡πâ‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£_${now.getFullYear()}-${(now.getMonth() + 1).toString().padStart(2, '0')}.pdf`;
                        a.download = fileName;
                        
                        document.body.appendChild(a);
                        a.click();
                        window.URL.revokeObjectURL(url);
                        document.body.removeChild(a);
                        
                        Swal.fire({
                            icon: 'success',
                            title: '‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!',
                            text: `‡πÑ‡∏ü‡∏•‡πå ${fileName} ‡πÑ‡∏î‡πâ‡∏ñ‡∏π‡∏Å‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏•‡πâ‡∏ß`,
                            confirmButtonText: '‡∏ï‡∏Å‡∏•‡∏á'
                        });
                    } else {
                        throw new Error('‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà PDF ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏™‡∏µ‡∏¢‡∏´‡∏≤‡∏¢');
                    }
                } else {
                    const errorData = await response.json().catch(() => null);
                    const errorMessage = errorData?.message || `HTTP ${response.status}: ${response.statusText}`;
                    throw new Error(errorMessage);
                }
            } catch (error) {
                console.error('‚ùå Error generating report:', error);
                
                let errorMessage = '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô';
                if (error.message.includes('PDF service ‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô')) {
                    errorMessage = '‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏£‡πâ‡∏≤‡∏á PDF ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö';
                } else if (error.message.includes('puppeteer')) {
                    errorMessage = '‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏£‡πâ‡∏≤‡∏á PDF ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö';
                } else if (error.message) {
                    errorMessage += ': ' + error.message;
                }
                
                Swal.fire({
                    icon: 'error',
                    title: '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ',
                    html: `
                        <div style="color: #e2e8f0; text-align: left;">
                            <p><strong>‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏:</strong> ${errorMessage}</p>
                            <hr style="margin: 1rem 0; border-color: rgba(251, 191, 36, 0.3);">
                            <p><strong>‡∏ó‡∏≤‡∏á‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏∑‡πà‡∏ô:</strong></p>
                            <ul style="margin-top: 0.5rem;">
                                <li>‡πÉ‡∏ä‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô Print ‡∏Ç‡∏≠‡∏á‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå</li>
                                <li>‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏õ‡πá‡∏ô Excel</li>
                                <li>‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö</li>
                            </ul>
                        </div>
                    `,
                    confirmButtonText: '‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡πÅ‡∏•‡πâ‡∏ß',
                    footer: `
                        <div style="color: #94a3b8; font-size: 0.8rem;">
                            ‡∏´‡∏≤‡∏Å‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏¢‡∏±‡∏á‡∏Ñ‡∏á‡∏≠‡∏¢‡∏π‡πà ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö
                        </div>
                    `
                });
            }
        }

        // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå
        function populateProfilePage() {
            if (!currentUser) return;

            document.getElementById('profilePageAvatar').textContent = currentUser.username.charAt(0).toUpperCase();
            document.getElementById('profilePageUsername').textContent = currentUser.username;
            document.getElementById('profilePageRole').textContent = getRoleDisplayName(currentUser.role);
            document.getElementById('profilePageFullName').textContent = currentUser.fullName || '-';
            document.getElementById('profilePageEmail').textContent = currentUser.email || '-';
            document.getElementById('profilePageLastLogin').textContent = currentUser.lastLogin ? formatDateThai(currentUser.lastLogin) : '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏Ñ‡∏¢‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏ä‡πâ';
            document.getElementById('profilePageStatus').textContent = currentUser.isActive ? '‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô' : '‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô';
        }

        // ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö
        function handleLogout() {
            Swal.fire({
                title: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö',
                text: '‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?',
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: '‚úÖ ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö',
                cancelButtonText: '‚ùå ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å',
                reverseButtons: true
            }).then((result) => {
                if (result.isConfirmed) {
                    if (window.AuthUtils && typeof window.AuthUtils.logout === 'function') {
                        window.AuthUtils.logout();
                    } else {
                        localStorage.removeItem('authToken');
                        localStorage.removeItem('authUser');
                        window.location.href = '/admin/login';
                    }
                }
            });
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠
        function getRoleDisplayName(role) {
            const roles = {
                'admin': '‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö',
                'executive': '‡∏ú‡∏π‡πâ‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£',
                'technician': '‡∏ä‡πà‡∏≤‡∏á‡πÄ‡∏ó‡∏Ñ‡∏ô‡∏¥‡∏Ñ'
            };
            return roles[role] || role;
        }

        function getStatusClass(status) {
            switch (status) {
                case '‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£': return 'status-pending';
                case '‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß‡∏£‡∏≠‡∏ä‡πà‡∏≤‡∏á': return 'status-approved';
                case '‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÇ‡∏î‡∏¢‡∏ú‡∏π‡πâ‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£': return 'status-rejected';
                default: return 'status-pending';
            }
        }

        // SweetAlert2 Toast
        function showToast(message, type = 'info') {
            const iconMap = {
                success: 'success',
                error: 'error',
                warning: 'warning',
                info: 'info'
            };

            Swal.fire({
                icon: iconMap[type],
                title: message,
                toast: true,
                position: 'top-end',
                showConfirmButton: false,
                timer: 4000,
                timerProgressBar: false,
                background: 'linear-gradient(135deg, rgba(30, 41, 59, 0.95), rgba(51, 65, 85, 0.95))',
                color: '#f8fafc',
                didOpen: (toast) => {
                    toast.addEventListener('mouseenter', Swal.stopTimer)
                    toast.addEventListener('mouseleave', Swal.resumeTimer)
                }
            });
        }

        // Auto refresh data every 5 minutes
        setInterval(async () => {
            if (!document.hidden && window.AuthUtils && typeof window.AuthUtils.isAuthenticated === 'function' && window.AuthUtils.isAuthenticated()) {
                console.log('üîÑ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥...');
                await loadAllData();
            }
        }, 5 * 60 * 1000); // 5 minutes

        // Refresh when page becomes visible
        document.addEventListener('visibilitychange', function() {
            if (!document.hidden && window.AuthUtils && typeof window.AuthUtils.isAuthenticated === 'function' && window.AuthUtils.isAuthenticated()) {
                loadAllData();
            }
        });

        // PWA Service Worker Registration
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/executive-sw.js')
                .then((registration) => {
                    console.log('‚úÖ Executive Service Worker registered:', registration.scope);
                    
                    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï
                    registration.addEventListener('updatefound', () => {
                        const newWorker = registration.installing;
                        newWorker.addEventListener('statechange', () => {
                            if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                showToast('üîÑ ‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÉ‡∏´‡∏°‡πà ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏´‡∏ô‡πâ‡∏≤', 'info');
                            }
                        });
                    });
                })
                .catch((error) => {
                    console.error('‚ùå Service Worker registration failed:', error);
                });
        }

        // PWA Install Prompt
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            
            // ‡πÅ‡∏™‡∏î‡∏á‡∏õ‡∏∏‡πà‡∏°‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á‡∏´‡∏£‡∏∑‡∏≠ banner
            showInstallBanner();
        });

        function showInstallBanner() {
            const banner = document.createElement('div');
            banner.innerHTML = `
                <div style="position: fixed; top: 0; left: 0; right: 0; background: linear-gradient(135deg, #1e3a8a, #3b82f6); color: white; padding: 15px; text-align: center; z-index: 10000; box-shadow: 0 2px 10px rgba(0,0,0,0.3);">
                    <div style="max-width: 400px; margin: 0 auto;">
                        <p style="margin: 0 0 10px 0; font-weight: 600;">üì± ‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏≠‡∏õ Smart Pole Executive</p>
                        <button onclick="installPWA()" style="background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.3); padding: 8px 20px; border-radius: 20px; margin: 0 5px; cursor: pointer; backdrop-filter: blur(10px);">‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á</button>
                        <button onclick="this.parentElement.parentElement.remove()" style="background: rgba(255,255,255,0.1); color: white; border: 1px solid rgba(255,255,255,0.2); padding: 8px 20px; border-radius: 20px; margin: 0 5px; cursor: pointer;">‡∏õ‡∏¥‡∏î</button>
                    </div>
                </div>
            `;
            document.body.appendChild(banner);
        }

        window.installPWA = async function() {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                const result = await deferredPrompt.userChoice;
                
                if (result.outcome === 'accepted') {
                    showToast('üéâ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏≠‡∏õ...', 'success');
                } else {
                    showToast('üòî ‡∏Å‡∏≤‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á‡∏ñ‡∏π‡∏Å‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å', 'warning');
                }
                
                deferredPrompt = null;
                document.querySelector('[style*="position: fixed"]')?.remove();
            }
        };

        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÅ‡∏≠‡∏õ‡∏ñ‡∏π‡∏Å‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏•‡πâ‡∏ß‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
        window.addEventListener('appinstalled', () => {
            showToast('üéâ ‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏≠‡∏õ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß!', 'success');
            document.querySelector('[style*="position: fixed"]')?.remove();
        });
    </script>
</body>
</html>
